<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Processing the WM_IME_COMPOSITION Message</title>
<style>
table th { border: 1px solid; }
table td { border: 1px solid; }
</style>
</head>
<body>
<hr />
<h2>description: An IME-aware application that processes the WM_IME_COMPOSITION message tests the bits in lParam parameter and calls the ImmGetCompositionString function to retrieve the indicated string or data.
ms.assetid: 6d9cb9e2-f30e-4299-9af5-a705cd40b185
title: Processing the WM_IME_COMPOSITION Message
ms.topic: article
ms.date: 05/31/2018</h2>
<h1>Processing the WM_IME_COMPOSITION Message</h1>
<p>An IME-aware application that processes the <a href="wm-ime-composition.html"><strong>WM_IME_COMPOSITION</strong></a> message tests the bits in <em>lParam</em> parameter and calls the <a href="/windows/desktop/api/Imm/nf-imm-immgetcompositionstringa"><strong>ImmGetCompositionString</strong></a> function to retrieve the indicated string or data. The following example checks for the result string, allocates sufficient memory for the string, and retrieves the result string from the IME.</p>
<pre lang="C++"><code>HIMC hIMC;
DWORD dwSize;
HGLOBAL hstr;
LPSTR lpstr;

case WM_IME_COMPOSITION:
    if (lParam &amp; GCS_RESULTSTR) 
    {
        hIMC = ImmGetContext(hWnd);

        if (!hIMC)
            MyError(ERROR_NULLCONTEXT);

        // Get the size of the result string. 
        dwSize = ImmGetCompositionString(hIMC, GCS_RESULTSTR, NULL, 0);

        // increase buffer size for terminating null character,  
        //   maybe it is in UNICODE 
        dwSize += sizeof(WCHAR);

        hstr = GlobalAlloc(GHND,dwSize);
        if (hstr == NULL)
             MyError(ERROR_GLOBALALLOC);

        lpstr = (LPSTR)GlobalLock(hstr);
        if (lpstr == NULL)
             MyError(ERROR_GLOBALLOCK);

        // Get the result strings that is generated by IME into lpstr. 
        ImmGetCompositionString(hIMC, GCS_RESULTSTR, lpstr, dwSize);
        ImmReleaseContext(hWnd, hIMC);

        // add this string into text buffer of application 

        GlobalUnlock(hstr);
        GlobalFree(hstr);
    }
</code></pre>
<h2>Related topics</h2>
<!-- raw HTML omitted -->
<p><a href="using-input-method-manager.html">Using Input Method Manager</a></p>
<!-- raw HTML omitted -->
<p>Â </p>
<p>Â </p>
</body>
