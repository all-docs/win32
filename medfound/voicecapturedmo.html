<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Voice Capture DSP</title>
<style>
table th { border: 1px solid; }
table td { border: 1px solid; }
</style>
</head>
<body>
<hr />
<h2>description: An object that encapsulates several DSPs related to voice capture.
ms.assetid: 6c77c8f6-289e-4130-b56a-e1f0bcc40f3e
title: Voice Capture DSP (Wmcodecdsp.h)
ms.topic: reference
ms.date: 05/31/2018</h2>
<h1>Voice Capture DSP</h1>
<p>An object that encapsulates several DSPs related to voice capture.</p>
<h2>CLSID</h2>
<p>CLSID_CWMAudioAEC</p>
<h2>Interfaces</h2>
<ul>
<li><a href="/previous-versions/windows/desktop/api/mediaobj/nn-mediaobj-imediaobject"><strong>IMediaObject</strong></a></li>
<li><strong>IPropertyStore</strong></li>
</ul>
<h2>Properties</h2>
<table>
<thead>
<tr>
<th>Property</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="mfpkey-wmaaecma-device-indexesproperty.html">MFPKEY_WMAAECMA_DEVICE_INDEXES</a></td>
<td>Specifies which audio devices the DMO uses for capturing and rendering audio.</td>
</tr>
<tr>
<td><a href="mfpkey-wmaaecma-devicepair-guidproperty.html">MFPKEY_WMAAECMA_DEVICEPAIR_GUID</a></td>
<td>Identifies the combination of audio devices that the application is currently using.</td>
</tr>
<tr>
<td><a href="mfpkey-wmaaecma-dmo-source-modeproperty.html">MFPKEY_WMAAECMA_DMO_SOURCE_MODE</a></td>
<td>Specifies whether the DMO uses source mode or filter mode.</td>
</tr>
<tr>
<td><a href="mfpkey-wmaaecma-featr-aesproperty.html">MFPKEY_WMAAECMA_FEATR_AES</a></td>
<td>Specifies how many times the DMO performs acoustic echo suppression (AES) on the residual signal.</td>
</tr>
<tr>
<td><a href="mfpkey-wmaaecma-featr-agcproperty.html">MFPKEY_WMAAECMA_FEATR_AGC</a></td>
<td>Specifies whether the DMO performs automatic gain control.</td>
</tr>
<tr>
<td><a href="mfpkey-wmaaecma-featr-center-clipproperty.html">MFPKEY_WMAAECMA_FEATR_CENTER_CLIP</a></td>
<td>Specifies whether the DMO performs center clipping.</td>
</tr>
<tr>
<td><a href="mfpkey-wmaaecma-featr-echo-lengthproperty.html">MFPKEY_WMAAECMA_FEATR_ECHO_LENGTH</a></td>
<td>Specifies the duration of echo that the acoustic echo cancellation (AEC) algorithm can handle.</td>
</tr>
<tr>
<td><a href="mfpkey-wmaaecma-featr-frame-sizeproperty.html">MFPKEY_WMAAECMA_FEATR_FRAME_SIZE</a></td>
<td>Specifies the audio frame size.</td>
</tr>
<tr>
<td><a href="mfpkey-wmaaecma-featr-micarr-beamproperty.html">MFPKEY_WMAAECMA_FEATR_MICARR_BEAM</a></td>
<td>Specifies which beam the DMO uses for microphone array processing.</td>
</tr>
<tr>
<td><a href="mfpkey-wmaaecma-featr-micarr-modeproperty.html">MFPKEY_WMAAECMA_FEATR_MICARR_MODE</a></td>
<td>Specifies how the DMO performs microphone array processing.</td>
</tr>
<tr>
<td><a href="mfpkey-wmaaecma-featr-micarr-preprocproperty.html">MFPKEY_WMAAECMA_FEATR_MICARR_PREPROC</a></td>
<td>Specifies whether the DMO performs microphone array preprocessing.</td>
</tr>
<tr>
<td><a href="mfpkey-wmaaecma-featr-noise-fillproperty.html">MFPKEY_WMAAECMA_FEATR_NOISE_FILL</a></td>
<td>Specifies whether the DMO performs noise filling.</td>
</tr>
<tr>
<td><a href="mfpkey-wmaaecma-featr-nsproperty.html">MFPKEY_WMAAECMA_FEATR_NS</a></td>
<td>Specifies whether the DMO performs noise suppression.</td>
</tr>
<tr>
<td><a href="mfpkey-wmaaecma-featr-vadproperty.html">MFPKEY_WMAAECMA_FEATR_VAD</a></td>
<td>Specifies the type of voice activity detection that the DMO performs.</td>
</tr>
<tr>
<td><a href="mfpkey-wmaaecma-feature-modeproperty.html">MFPKEY_WMAAECMA_FEATURE_MODE</a></td>
<td>Enables the application to override the default settings on various properties.</td>
</tr>
<tr>
<td><a href="mfpkey-wmaaecma-mic-gain-bounderproperty.html">MFPKEY_WMAAECMA_MIC_GAIN_BOUNDER</a></td>
<td>Specifies whether the DMO applies microphone gain bounding.</td>
</tr>
<tr>
<td><a href="mfpkey-wmaaecma-micarray-descptrproperty.html">MFPKEY_WMAAECMA_MICARRAY_DESCPTR</a></td>
<td>Specifies the microphone array geometry.</td>
</tr>
<tr>
<td><a href="mfpkey-wmaaecma-quality-metricsproperty.html">MFPKEY_WMAAECMA_QUALITY_METRICS</a></td>
<td>Retrieves quality metrics for AEC.</td>
</tr>
<tr>
<td><a href="mfpkey-wmaaecma-retrieve-ts-statsproperty.html">MFPKEY_WMAAECMA_RETRIEVE_TS_STATS</a></td>
<td>Specifies whether the DMO stores time stamp statistics in the registry.</td>
</tr>
<tr>
<td><a href="mfpkey-wmaaecma-system-modeproperty.html">MFPKEY_WMAAECMA_SYSTEM_MODE</a></td>
<td>Sets the processing mode.</td>
</tr>
</tbody>
</table>
<p>Â </p>
<h2>Remarks</h2>
<p>Unlike the other DSPs, the voice capture object encapsulates multiple DSPs in a single object, and the object is a DMO object only (it does not implement <a href="/windows/desktop/api/mftransform/nn-mftransform-imftransform"><strong>IMFTransform</strong></a>). The voice capture DMO includes the following DSP components:</p>
<ul>
<li>Acoustic echo cancellation (AEC)</li>
<li>Microphone array processing</li>
<li>Noise suppression</li>
<li>Automatic gain control</li>
<li>Voice activity detection</li>
</ul>
<p>Applications can turn each component on and off individually.</p>
<p>The voice capture DMO supports two modes of operation, <em>filter</em> mode and <em>source</em> mode. In filter mode, the application sends audio samples from the microphone and from the speaker line to the DMO, and the DMO produces output.</p>
<p>In source mode, the application does not need to deliver samples to the DMO. Instead, the DMO manages all of the operations on the audio devices, including initializing the devices, capturing and synchronizing the audio streams, calculating time stamps, and retrieving the geometry of the microphone array. Using source mode, the application simply configures the DMO, and the output from the DMO is a clean, processed microphone signal. Source mode is significantly easier to use than filter mode, and is recommended for most applications.</p>
<p>Currently the voice capture DMO supports only single-channel acoustic echo cancellation (AEC), so the output from the speaker line must be single-channel. If microphone array processing is disabled, multi-channel input is folded down to one channel for AEC processing. If both microphone array processing and AEC processing are enabled, AEC is performed on each microphone element before microphone array processing.</p>
<h3>Microphone Array Processing</h3>
<p>A microphone array is a set of closely positioned microphones. Microphone arrays achieve better directionality than a single microphone, because the acoustic waves arrive at each microphone at a slightly different time. For more information on microphone arrays see the web articles <a href="/windows-hardware/design/component-guidelines/audio">Microphone Array Support in Windows Vista</a> and <a href="/windows-hardware/drivers/audio/microphone-array-geometry-descriptor-format">How to Build and Use Microphone Arrays for Windows Vista</a>.</p>
<h3>Using the Voice Capture DSP</h3>
<p>To use the Voice Capture DSP, perform the following steps.</p>
<h3>1. Initialize the DMO</h3>
<p>Create the voice capture DMO by calling <a href="/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance"><strong>CoCreateInstance</strong></a> with the CLSID <strong>CLSID_CWMAudioAEC</strong>. The voice capture DSDP exposes only the <a href="/previous-versions/windows/desktop/api/mediaobj/nn-mediaobj-imediaobject"><strong>IMediaObject</strong></a> and <a href="/windows/win32/api/propsys/nn-propsys-ipropertystore"><strong>IPropertyStore</strong></a> interfaces, so it can only be used as a DMO.</p>
<p>The DMO defaults to source mode. To select filter mode, set the <a href="mfpkey-wmaaecma-dmo-source-modeproperty.html">MFPKEY_WMAAECMA_DMO_SOURCE_MODE</a> property to <strong>VARIANT_FALSE</strong>.</p>
<p>Next, configure the internal properties of the DMO by using the <a href="/windows/win32/api/propsys/nn-propsys-ipropertystore"><strong>IPropertyStore</strong></a> interface. The only property that an application must set is the <a href="mfpkey-wmaaecma-system-modeproperty.html">MFPKEY_WMAAECMA_SYSTEM_MODE</a> property. This property configures the processing pipeline within the DMO. The other properties are optional.</p>
<h3>2. Set the Input and Output Formats</h3>
<p>If you are using the DMO in filter mode, set the input format by calling <a href="/previous-versions/windows/desktop/api/mediaobj/nf-mediaobj-imediaobject-setinputtype"><strong>IMediaObject::SetInputType</strong></a>. The input format can be almost any valid uncompressed PCM or IEEE floating-point audio type. If the input format does not match the output format, the DMO automatically performs sample-rate conversion.</p>
<p>If you are using the DMO in source mode, do not set the input format. The DMO automatically configures the input format based on the audio devices.</p>
<p>In either mode, set the output format by calling <a href="/previous-versions/windows/desktop/api/mediaobj/nf-mediaobj-imediaobject-setoutputtype"><strong>IMediaObject::SetOutputType</strong></a>. The DMO can accept the following output formats:</p>
<ul>
<li>Subtype: <strong>MEDIASUBTYPE_PCM</strong> or <strong>MEDIASUBTYPE_IEEE_FLOAT</strong></li>
<li>Format block: <a href="/windows/win32/api/mmreg/ns-mmreg-waveformat"><strong>WAVEFORMAT</strong></a> or <a href="/previous-versions/dd757713(v=vs.85)"><strong>WAVEFORMATEX</strong></a></li>
<li>Samples per second: 8,000; 11,025; 16,000; or 22,050</li>
<li>Channels: 1 for AEC-only mode, 2 or 4 for microphone array processing</li>
<li>Bits per sample: 16</li>
</ul>
<p>The following code sets the output type to 16-bit single-channel PCM audio:</p>
<pre><code>DMO_MEDIA_TYPE mt;  // Media type.
mt.majortype = MEDIATYPE_Audio;
mt.subtype = MEDIASUBTYPE_PCM;
mt.lSampleSize = 0;
mt.bFixedSizeSamples = TRUE;
mt.bTemporalCompression = FALSE;
mt.formattype = FORMAT_WaveFormatEx;

// Allocate the format block to hold the WAVEFORMATEX structure.
hr = MoInitMediaType(&amp;mt, sizeof(WAVEFORMATEX));
if (SUCCEEDED(hr))
{
    WAVEFORMATEX *pwav = (WAVEFORMATEX*)mt.pbFormat;
    pwav-&gt;wFormatTag = WAVE_FORMAT_PCM;
    pwav-&gt;nChannels = 1;
    pwav-&gt;nSamplesPerSec = 16000;
    pwav-&gt;nAvgBytesPerSec = 32000;
    pwav-&gt;nBlockAlign = 2;
    pwav-&gt;wBitsPerSample = 16;
    pwav-&gt;cbSize = 0;

    // Set the output type.
    if (SUCCEEDED(hr))
    {
        hr = pDMO-&gt;SetOutputType(0, &amp;mt, 0); 
    }
    // Free the format block.
    MoFreeMediaType(&amp;mt);
}
</code></pre>
<h3>3. Process Data</h3>
<p>Before processing any data, it is recommended to call <a href="/previous-versions/windows/desktop/api/mediaobj/nf-mediaobj-imediaobject-allocatestreamingresources"><strong>IMediaObject::AllocateStreamingResources</strong></a>. This method allocates the resources used internally by the DMO. Call <strong>AllocateStreamingResources</strong> after the steps listed previously, not before. If you do not call this method, the DMO automatically allocates resources when data processing starts.</p>
<p>If you are using the DMO in filter mode, you must pass input data to the DMO by calling <a href="/previous-versions/windows/desktop/api/mediaobj/nf-mediaobj-imediaobject-processinput"><strong>IMediaObject::ProcessInput</strong></a>. The audio data from the microphone goes to stream 0, and the audio data from the speaker line goes to stream 1. If you are using the DMO in source mode, you do not need to call <strong>ProcessInput</strong>.</p>
<p>To get output data from the DSP, perform the following steps:</p>
<ol>
<li>Create a buffer object to hold the output data. The buffer object must implement the <a href="/previous-versions/windows/desktop/api/mediaobj/nn-mediaobj-imediabuffer"><strong>IMediaBuffer</strong></a> interface. The size of the buffer depends on the requirements of your application. Allocating a larger buffer can reduce the chances of glitches occurring.</li>
<li>Declare a <a href="/previous-versions/windows/desktop/api/mediaobj/ns-mediaobj-dmo_output_data_buffer"><strong>DMO_OUTPUT_DATA_BUFFER</strong></a> structure and set the <strong>pBuffer</strong> member to point to your buffer object.</li>
<li>Pass the <a href="/previous-versions/windows/desktop/api/mediaobj/ns-mediaobj-dmo_output_data_buffer"><strong>DMO_OUTPUT_DATA_BUFFER</strong></a> structure to the <a href="/previous-versions/windows/desktop/api/mediaobj/nf-mediaobj-imediaobject-processoutput"><strong>IMediaObject::ProcessOutput</strong></a> method.</li>
<li>Continue to call this method for as long as the DMO has output data. The DSP signals that it has more output by setting the <strong>DMO_OUTPUT_DATA_BUFFERF_INCOMPLETE</strong> flag in the <strong>dwStatus</strong> member of the <a href="/previous-versions/windows/desktop/api/mediaobj/ns-mediaobj-dmo_output_data_buffer"><strong>DMO_OUTPUT_DATA_BUFFER</strong></a> structure.</li>
</ol>
<h2>Requirements</h2>
<table>
<thead>
<tr>
<th>Requirement</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Minimum supported client<!-- raw HTML omitted --></td>
<td>WindowsÂ Vista [desktop apps only]<!-- raw HTML omitted --></td>
</tr>
<tr>
<td>Minimum supported server<!-- raw HTML omitted --></td>
<td>Windows ServerÂ 2008 [desktop apps only]<!-- raw HTML omitted --></td>
</tr>
<tr>
<td>Header<!-- raw HTML omitted --></td>
<td><!-- raw HTML omitted --> <!-- raw HTML omitted -->Wmcodecdsp.h<!-- raw HTML omitted --> <!-- raw HTML omitted --></td>
</tr>
<tr>
<td>DLL<!-- raw HTML omitted --></td>
<td><!-- raw HTML omitted --> <!-- raw HTML omitted -->Mfwmaaec.dll<!-- raw HTML omitted --> <!-- raw HTML omitted --></td>
</tr>
</tbody>
</table>
<h2>See also</h2>
<!-- raw HTML omitted -->
<p><a href="windowsmediadigitalsignalprocessors.html">Digital Signal Processors</a></p>
<!-- raw HTML omitted -->
<p>Â </p>
<p>Â </p>
</body>
