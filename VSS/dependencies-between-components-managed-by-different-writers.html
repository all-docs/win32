<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Dependencies between Components Managed by Different Writers</title>
<style>
table th { border: 1px solid; }
table td { border: 1px solid; }
</style>
</head>
<body>
<hr />
<h2>description: There are situations where data from one writer depends on data managed by another writer. In these cases, you should back up or restore data from both writers.
ms.assetid: 0413c289-74b7-4e83-a227-00bfb264e56e
title: Dependencies between Components Managed by Different Writers
ms.topic: article
ms.date: 05/31/2018</h2>
<h1>Dependencies between Components Managed by Different Writers</h1>
<p>There are situations where data from one writer depends on data managed by another writer. In these cases, you should back up or restore data from both writers.</p>
<p>VSS handles this problem through the notion of an explicit writer-component dependency and the <a href="/windows/desktop/api/VsWriter/nl-vswriter-ivsswmdependency"><strong>IVssWMDependency</strong></a> interface.</p>
<p>A writer adds one or more dependencies while creating the Writer Metadata Document using the <a href="/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addcomponentdependency"><strong>IVssCreateWriterMetadata::AddComponentDependency</strong></a> method. The writer passes the method the name and logical path of the dependent component (which it manages), as well as the name and logical path and the <a href="vssgloss-w.html"><em>writer class ID</em></a> (the GUID identifying the class) of the component upon which it depends.</p>
<p>Once established, this dependency informs the requester that during any backup or restore operation both the dependent component and the targets of its dependencies must participate.</p>
<p>A given component can have multiple dependencies, which requires that it and all its dependent targets participate in the backup and restore together.</p>
<p>The dependent component and/or the target(s) of its dependencies can be included either <a href="vssgloss-e.html"><em>explicitly</em></a> or <a href="vssgloss-i.html"><em>implicitly</em></a> in a backup or restore operations.</p>
<p>The explicit writer component dependency mechanism should not be used to create a dependency between two components on the same writer. The selection rules can supply the same functionality more efficiently without risk of circular dependencies.</p>
<p>As an example, <a href="/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addcomponentdependency"><strong>IVssCreateWriterMetadata::AddComponentDependency</strong></a> could be used to define the dependency of the component writerData (with logical path &quot;&quot;) of the writer MyWriter on component internetData (with a logical path of &quot;Connections&quot;) of a writer named InternetConnector with a writer Class ID X. (While it is possible for multiple writers with the same class ID to be on the system simultaneously, confusion will be avoided because the combination of logical path and component name is unique on the system under VSS.)</p>
<p>A writer adds multiple dependencies to a given component simply by calling <a href="/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addcomponentdependency"><strong>IVssCreateWriterMetadata::AddComponentDependency</strong></a> repeated with different components from different writers. The number of other components a given component depends on can be found by examining the <strong>cDependencies</strong> member of the <a href="/windows/desktop/api/VsBackup/ns-vsbackup-vss_componentinfo"><strong>VSS_COMPONENTINFO</strong></a> structure.</p>
<p>A writer or requester retrieves instances of the <a href="/windows/desktop/api/VsWriter/nl-vswriter-ivsswmdependency"><strong>IVssWMDependency</strong></a> interface with <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdependency"><strong>IVssWMComponent::GetDependency</strong></a>. The <strong>IVssWMDependency</strong> returns the component name, logical path, and class ID of the writer managing the component that is the target of the dependency.</p>
<p>The dependency mechanism does not prescribe any particular order of preference between the dependent component and the targets of its dependencies. As noted above, all a dependency indicates is that whenever a given component is either backed up or restored, the component or components it depends on must be backed up or restored as well. The exact implementation of dependency is at the discretion of the backup application.</p>
<p>For example, in the case above, the component writerData (logical path &quot;&quot;) depends on component InternetConnector (logical path &quot;Connections&quot;). A requester is free to interpret this in either of the following ways:</p>
<ul>
<li>If the dependent component, writerData, is selected (implicitly or explicitly) for backup or restore, the requester must select (either implicitly or explicitly) the target of its dependency, internetData</li>
<li>If the target of its dependency, internetData, is not selected for backup, then the dependent component, writerData, should not be selected.</li>
</ul>
<p>However, when developing support for dependencies, requester developers should be aware that there is no way a writer can determine if one of its components is a target of a dependency.</p>
<h2>Declaring Remote Dependencies</h2>
<p>A distributed application is an application that can be configured to use one or more computers at a time. Typically the application runs on one or more application server computers and communicates with (but may or may not actually run on) one or more database server computers. This configuration is sometimes referred to as a multi-system deployment. Often the same application can also be configured to run on a single computer that runs both an application server and a database server. Such a configuration is called a single-system deployment. In both configurations, the application server and database server each have their own independent VSS writers.</p>
<p>In a multi-system deployment, if a component managed by the application's writer depends on a remote component managed by the database server's writer, this is called a remote dependency. (A single-system deployment, in contrast, has only local dependencies.)</p>
<p>As an example of a multi-system deployment, consider an application server that uses a SQL Server database server as a data store. The application-specific data, which includes the web parts, web content files, and the IIS metabase, resides on one or more computers, called front-end web servers. The actual SQL data store, which includes the Config database and multiple Content databases, resides on one or more other computers, called back-end database servers. Each of the front-end web servers contains the same application-specific content and configuration. Each of the back-end database servers can host any of the Content databases or the Config database. The application software runs only on the front-end web servers, not on the database servers. In this configuration, the application's VSS writer has remote dependencies on the components managed by the SQL writer.</p>
<p>A writer can declare a remote dependency by calling the <a href="/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addcomponentdependency"><strong>AddComponentDependency</strong></a> method, prepending &quot;\\<em>RemoteComputerName</em>\&quot;, where <em>RemoteComputerName</em> is the name of the computer where the remote component resides, to the logical path in the <em>wszOnLogicalPath</em> parameter. The value of <em>RemoteComputerName</em> can be an IP address or a computer name returned by the <a href="/windows/win32/api/sysinfoapi/nf-sysinfoapi-getcomputernameexa"><strong>GetComputerNameEx</strong></a> function.</p>
<p><strong>Windows ServerÂ 2003:</strong> A writer cannot declare remote dependencies until Windows ServerÂ 2003 with Service PackÂ 1 (SP1).</p>
<p>To identify a dependency, a requester calls the <a href="/windows/desktop/api/VsWriter/nf-vswriter-ivsswmdependency-getwriterid"><strong>GetWriterId</strong></a>, <a href="/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getlogicalpath"><strong>GetLogicalPath</strong></a>, and <a href="/windows/desktop/api/VsWriter/nf-vswriter-ivsswmdependency-getcomponentname"><strong>GetComponentName</strong></a> methods of the <a href="/windows/desktop/api/VsWriter/nl-vswriter-ivsswmdependency"><strong>IVssWMDependency</strong></a> interface. The requester must examine the component name that <strong>GetComponentName</strong> returns in the <em>pbstrComponentName</em> parameter. If the component name begins with &quot;\\&quot;, the requester must assume that it specifies a remote dependency and that the first component following &quot;\\&quot; is the <em>RemoteComputerName</em> that was specified when the writer called <a href="/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addcomponentdependency"><strong>AddComponentDependency</strong></a>. If the component name does not begin with &quot;\\&quot;, the requester should assume that it specifies a local dependency.</p>
<p>If there is a remote dependency, the requester must back up the remote component when it backs up the local component. To back up the remote component, the requester should have an agent on the remote computer and should initiate the backup on the remote computer.</p>
<h2>Structuring Remote Dependencies</h2>
<p>It is important to understand that a dependency is not a component in and of itself. A component is necessary to hold the dependency.</p>
<p>The following examples show two ways to structure a set of dependencies.</p>
<pre lang="syntax"><code>Example 1:
    Writer 1
        Component A
            File A
            File B
            Dependency (SQL/MSDE Writer, Component X, &quot;\&quot;)
            Dependency (SQL/MSDE Writer, Component Y, &quot;\&quot;)

Example 2:
    Writer 2
        Component A
            File A
            File B
        Component B
            Dependency (SQL/MSDE Writer, Component X, &quot;\&quot;)
            Dependency (SQL/MSDE Writer, Component Y, &quot;\&quot;)
</code></pre>
<p>In example 1, the dependencies are held by Component A. Because only components can be selected, not individual files, structuring Component A's dependencies this way would require that the entire component, both the files and the dependencies, must always be backed up and restored together. They cannot be backed up or restored individually.</p>
<p>In example 2, separate components (Components A and B) hold each of the dependencies. In this case, the two components can be selected independently, and therefore backed up and restored independently. Structuring the dependencies this way gives a distributed application much more flexibility in managing its remote dependencies.</p>
<h2>Supporting Remote Dependencies</h2>
<p>A requester can provide full or partial support for remote dependencies.</p>
<p>To provide full support, the requester should do the following at backup and restore time.</p>
<p>At backup time, the requester must start the backup on the front-end (local) computer, determine the dependencies that exist, and spool additional backup jobs to capture the back-end databases. The requester must wait until after the back-end backup jobs on the remote computer have completed before calling the <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupsucceeded"><strong>IVssBackupComponents::SetBackupSucceeded</strong></a> and <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete"><strong>IVssBackupComponents::BackupComplete</strong></a> methods. If the requester waits until the backup of back-end components is complete before calling <strong>BackupComplete</strong>, this will produce a more easily recoverable backup for a writer that implements additional enhancementsâ€”such as topology locking, for exampleâ€”during the backup. The following procedure outlines what the requester should do:</p>
<ol>
<li>On the local computer, the requester calls the <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup"><strong>IVssBackupComponents::InitializeForBackup</strong></a>, <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata"><strong>IVssBackupComponents::GatherWriterMetadata</strong></a>, <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup"><strong>IVssBackupComponents::PrepareForBackup</strong></a>, and <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset"><strong>IVssBackupComponents::DoSnapshotSet</strong></a> methods.</li>
<li>After the local shadow copy is completed, but before the backup is completed, the requester spools additional backup jobs by sending a request to its agent on the remote computer.</li>
<li>On the remote computer, the requester's agent performs the spooled backup sequence by calling <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup"><strong>InitializeForBackup</strong></a>, <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata"><strong>GatherWriterMetadata</strong></a>, <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup"><strong>PrepareForBackup</strong></a>, <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset"><strong>DoSnapshotSet</strong></a>, <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupsucceeded"><strong>SetBackupSucceeded</strong></a>, and <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete"><strong>BackupComplete</strong></a>.</li>
<li>When the requester's agent has completed the spooled jobs on the remote computer, the requester completes the backup sequence by calling <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupsucceeded"><strong>SetBackupSucceeded</strong></a> and <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete"><strong>BackupComplete</strong></a>.</li>
</ol>
<p>At restore time, the requester must start the restore involving the front-end (local) computer, select the components and their dependencies to be restored, and then send the <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore"><strong>PreRestore</strong></a> event by calling the <strong>IVssBackupComponents::PreRestore</strong> method. The requester should then spool the back-end restore jobs on the remote computer and call the <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore"><strong>IVssBackupComponents::PostRestore</strong></a> method when the back-end restores are complete. This requirement gives the front-end writer more control over the restore experience and a better administrator user experience overall. Because the backups across each of the systems do not occur at the same point in time, the front-end writer will need to perform some cleanup of the back-end data. In the example application discussed in the preceding &quot;Declaring Remote Dependencies&quot;, the writer should initiate a site remapping or reindexing after a restore of one of the back-end databases has completed. To do this, the writer must receive events on the front-end server. The following procedure outlines what the requester should do:</p>
<ol>
<li>On the local computer, the requester calls <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore"><strong>IVssBackupComponents::InitializeForRestore</strong></a>, <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata"><strong>GatherWriterMetadata</strong></a>, <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setselectedforrestore"><strong>IVssBackupComponents::SetSelectedForRestore</strong></a> (or <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponentsex-setselectedforrestoreex"><strong>IVssBackupComponentsEx::SetSelectedForRestoreEx</strong></a>), and <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore"><strong>PreRestore</strong></a>.</li>
<li>After the <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore"><strong>PreRestore</strong></a> phase is completed, but before the <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore"><strong>PostRestore</strong></a> phase begins, the requester spools additional restore jobs by sending a request to its agent on the remote computer.</li>
<li>On the remote computer, the requester's agent performs the spooled restore jobs by calling <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore"><strong>InitializeForRestore</strong></a>, <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata"><strong>GatherWriterMetadata</strong></a>, <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setselectedforrestore"><strong>SetSelectedForRestore</strong></a>, <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore"><strong>PreRestore</strong></a>, <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setfilerestorestatus"><strong>SetFileRestoreStatus</strong></a> (or <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponentsex-setselectedforrestoreex"><strong>SetSelectedForRestoreEx</strong></a>), and <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore"><strong>PostRestore</strong></a>.</li>
<li>When the requester's agent has completed the spooled jobs on the remote computer, the requester completes the restore sequence by calling <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setfilerestorestatus"><strong>IVssBackupComponents::SetFileRestoreStatus</strong></a> and <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore"><strong>PostRestore</strong></a>.</li>
</ol>
<p>To provide partial support for remote dependencies, the requester must follow remote dependencies and include them as part of the backup, but the ordering of events on front-end and back-end systems as detailed in the previous two procedures would not be required. For a requester that implements only partial support, the requester should refer to the writer application's backup/restore documentation to understand what scenarios can be supported.</p>
<p>Â </p>
<p>Â </p>
</body>
