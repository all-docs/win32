<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Life Cycle of a Telephony Service Provider</title>
<style>
table th { border: 1px solid; }
table td { border: 1px solid; }
</style>
</head>
<body>
<hr />
<h2>description: This topic provides a high-level review of TSP operations.
ms.assetid: 8ee592ff-387e-449e-8e3f-4f6407166fe5
title: Life Cycle of a Telephony Service Provider
ms.topic: article
ms.date: 05/31/2018</h2>
<h1>Life Cycle of a Telephony Service Provider</h1>
<p>This topic provides a high-level review of TSP operations.</p>
<p>A session is the time during which a particular configuration remains valid and telephony operations are carried out. A service provider can support many sessions between the time it is first loaded and when it is finally freed. For each session, TAPI negotiates the version of the interface, starts the session, carries out operations, and eventually shuts down the session. The service provider must not retain information from one session to the next.</p>
<p>After the interface version is known, TAPI calls the <a href="/windows/win32/api/tspi/nf-tspi-tspi_providerinit"><strong>TSPI_providerInit</strong></a> function to set all operational parameters. The service provider is ensured that all of the configuration information in the registry is stable when the <strong>TSPI_providerInit</strong> function is called. Most service providers read all configuration information at that time.</p>
<p>Normal operations can proceed in any order, after the service provider is initialized.</p>
<p>TAPI negotiates device-specific information on a per-device basis. TAPI and the service provider commit to a version when a device is opened.</p>
<p>The service provider can receive requests to select and cancel extension versions. While an extension version is selected, the device operates strictly according to that device-specific extension version.</p>
<p>Negotiation of a device-specific extension version can happen multiple times, both before and after the device is opened. TAPI passes a version range, and the service provider chooses and returns a value from this range. Normally, the service provider has device-specific extensions disabled.</p>
<p>This commits both TAPI and the service provider to operating at that extension version level until the selection is canceled. During the time that a device-specific extension is in effect, an attempt to negotiate an extension version level should allow only the version level that is currently in effect. After the device-specific extension is canceled, a different version can be negotiated and selected.</p>
<p>Phone operations within the <strong>Open/Close</strong> pair are shown in the following illustration. Some of these operations are synchronous, others are asynchronous. If an operation completes asynchronously, another operation can be requested before the first reports completion. Thus, operations can overlap in any way. The service provider must eventually report completion for any asynchronous operation requested. Closing a phone forces outstanding asynchronous operations to complete (possibly with a &quot;failure&quot; indication).</p>
<p>The life cycle for line devices is similar to the life cycle for phones, except that lines have their own negotiation, initialization, open, and close procedures. Operations on open lines are bracketed by their own <strong>Open/Close</strong> pair. This pair is in turn bracketed between the same <strong>Initialization/Shutdown</strong> pair as the phone <strong>Open/Close</strong>.</p>
<p>The life cycles of calls are bracketed strictly between the <strong>Open/Close</strong> of the line that contains them. Lifetimes of calls can begin in several ways:</p>
<ul>
<li>Requested from TAPI through functions such as <a href="/windows/win32/api/tapi/nf-tapi-linemakecall"><strong>lineMakeCall</strong></a>, <a href="/windows/win32/api/tapi/nf-tapi-linesetuptransfer"><strong>lineSetupTransfer</strong></a>, or <a href="/windows/win32/api/tapi/nf-tapi-linesetupconference"><strong>lineSetupConference</strong></a>.</li>
<li>Spontaneously originated in the service provider as new incoming calls, user-initiated calls on an attached telephone handset, or calls generated as a side effect of other operations such as putting an existing call on hold.</li>
</ul>
<p>The lifetimes of distinct calls within the same line can overlap each other in any way. All calls end their lifetime at the time the TSPI function <a href="/windows/win32/api/tspi/nf-tspi-tspi_lineclosecall"><strong>TSPI_lineCloseCall</strong></a> is invoked. The life cycle of several calls is shown in the following illustration.</p>
<p><img src="images/modell.png" alt="life cycles of calls overlapping" /></p>
<p>A call can originate in TAPI as shown with the <strong>MakeCall/CloseCall</strong> pair. A call can also originate in the service provider. The service provider announces this with a <a href="line-newcall.html"><strong>LINE_NEWCALL</strong></a> message to a TAPI-supplied callback procedure. In such a case, TAPI returns its identifier for the call, which is included in subsequent callbacks reporting events occurring on the call. In the case of calls whose lifetime originates in TAPI, this identifier is included in the TSPI operation that creates the call.</p>
<p>All of the operations that start the lifetime of a call result in TAPI and service provider exchanging identifiers for the new call. In the case of TAPI originated calls, TAPI passes its identifier and receives the service provider's identifier as a return parameter. In the case where the call originates in the service provider, the service provider passes its identifier to TAPI and receives the TAPI identifier as a return parameter.</p>
<p>The following illustration offers a very high-level view of service provider installation, configuration, and removal; life-cycle sequences that span many sessions. The typical life-cycle for these operations can be shown with the following time line.</p>
<p><img src="images/model2.png" alt="service provider installation, configuration, and removal" /></p>
<p>The typical installation and removal life cycle is shown, spanning multiple sessions. Calls to the <strong>Install</strong> and <a href="/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove"><strong>Remove</strong></a> procedures are strictly paired and do not overlap. Calls to the <strong>Config</strong> procedure can happen multiple times within this pair. One is typically done by the service provider as an internal side effect of the <strong>Install</strong> procedure to create line and phone entries. The <strong>Config</strong> procedure may be called at other times to alter an existing setup. The <strong>Install</strong> procedure must be done before any other TSPI function is permitted. In the ideal scenario, all sessions are strictly nested within the <strong>Install/Remove</strong> procedure pair.</p>
<p>The functions <a href="/windows/win32/api/tspi/nf-tspi-tspi_providerinstall"><strong>TSPI_providerInstall</strong></a>, <a href="/windows/win32/api/tspi/nf-tspi-tspi_providerconfig"><strong>TSPI_providerConfig</strong></a>, and <a href="/windows/win32/api/tspi/nf-tspi-tspi_providerremove"><strong>TSPI_providerRemove</strong></a> interact with the service provider itself rather than with any specific device. They affect static configuration information that survives across multiple sessions and must be present for any other operation to proceed. Thus, all other operations are nested between the invocation of <strong>TSPI_providerInstall</strong> and the completion of its matching <strong>TSPI_providerRemove</strong>. These two operations typically happen very far apart, most likely in a different load of the service provider or a different boot of the machine. Calling the <strong>Config</strong> function externally is optional, because the <strong>Install</strong> procedure is required to include the <strong>Config</strong> behavior in addition to its own. The usual reason for calling it externally is to modify an existing configuration.</p>
<p>There is a subtlety embedded in the concept of the completion of a <a href="/windows/win32/api/tspi/nf-tspi-tspi_providerremove"><strong>TSPI_providerRemove</strong></a> operation. It is desirable to allow the user to run the Telephony Control Panel utility supplied with the telephony service to alter service provider configurations, even when telephony operations (sessions) are in progress. Consequently, both the <a href="/windows/win32/api/tspi/nf-tspi-tspi_providerconfig"><strong>TSPI_providerConfig</strong></a> and <strong>TSPI_providerRemove</strong> specifications allow for invocation while there is an outstanding session. However, any changes to the configuration are required to be delayed until telephony operations are shut down and restarted. Thus, strictly speaking, the completion of any <strong>TSPI_providerConfig</strong> or <strong>TSPI_providerRemove</strong> operation happens outside any session. The nesting of actions is as shown in the figure, even though the procedures calls may appear in a slightly different order. It is permitted for a service provider to simply disallow <strong>Config</strong> or <a href="/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove"><strong>Remove</strong></a> while operations are in progress, although the user should be notified with a dialog box. A more user-friendly implementation that allows at least a subset of operations is preferred.</p>
<p>These <strong>Install</strong>, <strong>Config</strong>, and <a href="/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove"><strong>Remove</strong></a> operations all have the side effect of signaling any running telephony applications, which eventually results in them shutting down their use of the telephony service. Together, this ends all outstanding sessions for service providers. This signifies to service providers that they must read the new registry configuration when new sessions begin. Any changes that were pending due to a <strong>Config</strong> or <a href="/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove"><strong>Remove</strong></a> while operations were in progress then take effect.</p>
<p>Â </p>
<p>Â </p>
</body>
