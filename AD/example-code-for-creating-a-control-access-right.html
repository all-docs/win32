<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Example Code for Creating a Control Access Right</title>
<style>
table th { border: 1px solid; }
table td { border: 1px solid; }
</style>
</head>
<body>
<hr />
<h2>title: Example Code for Creating a Control Access Right
description: This topic includes a code example that creates a controlAccessRight object in the Extended-Rights container.
ms.assetid: b1b644ee-c38a-47da-8a0a-31a06361f35a
ms.tgt_platform: multiple
ms.topic: article
ms.date: 05/31/2018</h2>
<h1>Example Code for Creating a Control Access Right</h1>
<p>The following Visual Basic example creates a <strong>controlAccessRight</strong> object in the Extended-Rights container.</p>
<pre lang="VB"><code>Dim ExContainer As IADsContainer
Dim rootdse As IADs
Dim ExRight As IADs

On Error GoTo CleanUp
 
Set rootdse = GetObject(&quot;LDAP://rootDSE&quot;)
configpath = rootdse.Get(&quot;configurationNamingContext&quot;)
Set ExContainer = GetObject(&quot;LDAP://cn=extended-rights,&quot; &amp; configpath)
 
' Create the object, specifying the object class and the cn.
Set ExRight = ExContainer.Create(&quot;controlAccessRight&quot;, &quot;cn=MyExRight&quot;)
 
' Set the classes that the right applies to.
' Specify the schemaIDGUID of the user and computer classes.
ExRight.PutEx ADS_PROPERTY_UPDATE, &quot;appliesTo&quot;, _
         Array(&quot;bf967aba-0de6-11d0-a285-00aa003049e2&quot;, _
               &quot;bf967a86-0de6-11d0-a285-00aa003049e2&quot;)
 
' Set the display name used in Security property pages and other UI.
ExRight.PutEx ADS_PROPERTY_UPDATE, 
              &quot;displayName&quot;, 
              Array(&quot;My-Extended-Right&quot;)
 
' Set rightsGUID to a GUID generated by Uuidgen.exe.
ExRight.PutEx ADS_PROPERTY_UPDATE, &quot;rightsGUID&quot;, _
               Array(&quot;64ad33ac-ea09-4ded-b798-a0585c50fd5a&quot;)

' Set validAccesses to indicate a control access right.
ExRight.PutEx ADS_PROPERTY_UPDATE, &quot;validAccesses&quot;, &amp;H100

ExRight.SetInfo

Exit Sub

CleanUp:
    MsgBox (&quot;An error has occurred.&quot;)
    ExContainer = Nothing
    rootdse = Nothing
    ExRight = Nothing
</code></pre>
<p>The following C++ code example is a function that creates a <strong>controlAccessRight</strong> object in the Extended-Rights container. When you call this function, use the following format to specify the GUID string for the <em>pszRightsGUID</em> parameter.</p>
<pre lang="C++"><code>L&quot;b7b13123-b82e-11d0-afee-0000f80367c1&quot;
</code></pre>
<p>The <strong>ADSVALUE</strong> array for the <strong>appliesTo</strong> property uses the same GUID format and sets the <strong>dwType</strong> member to <strong>ADSTYPE_CASE_IGNORE_STRING</strong>.</p>
<pre lang="C++"><code>#define _WIN32_WINNT 0x0500
 
#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;
#include &lt;activeds.h&gt;
 
// ****************************************************************
//  CreateExtendedRight
// ****************************************************************
HRESULT CreateExtendedRight(
             LPWSTR pszCommonName,     // cn property
             LPWSTR pszDisplayName,    // displayName property
             LPWSTR pszRightsGUID,     // rightsGUID property
             ADSVALUE *pAdsvAppliesTo, // array of GUIDs for appliesTo property
             int cAppliesTo )          // number of GUIDs in array
{
HRESULT hr = E_FAIL;
VARIANT var;
LPOLESTR szADsPath = NULL;
IADs *pRootDSE = NULL;
IDirectoryObject *pExRights = NULL;
UINT nSize = 0;
WCHAR *lpszExtRights = L&quot;LDAP://cn=Extended-Rights,&quot; 

const int cAttributes = 6;   // Count of attributes that must be set to create a control access right.
PADS_ATTR_INFO pAttributeEntries = new ADS_ATTR_INFO[cAttributes];  // array of attributes
ADSVALUE adsvCN,
         adsvObjectClass,
         adsvDisplayName,
         adsvRightsGUID,
         adsvValidAccesses;
 
LPOLESTR pszRightRelPath = new WCHAR[MAX_PATH];
IDispatch *pNewObject = NULL;
 
hr = ADsOpenObject(L&quot;LDAP://rootDSE&quot;,
                   NULL,
                   NULL,
                   ADS_SECURE_AUTHENTICATION, // Use Secure Authentication.
                   IID_IADs,
                   (void**)&amp;pRootDSE);
if (FAILED(hr)) {
    wprintf(L&quot;Bind to rootDSE failed: 0x%x\n&quot;, hr);
    return hr;
}
 
// Get the DN to the config container.
hr = pRootDSE-&gt;Get(CComBSTR(&quot;configurationNamingContext&quot;), &amp;var);
if (SUCCEEDED(hr))
{
    // Determine the buffer size required to store the ADsPath string
    // and allocate the buffer.
    nSize = wcslen(lpszExtRights) + wcslen(var.bstrVal) + 1;
    szADsPath = new OLECHAR[nSize];

    if (szADsPath == NULL)
    {
        wprintf(L&quot;Buffer allocation failed.&quot;);
        goto cleanup;
    }

    // Build ADsPath string to Extended-Rights container
    wcsncpy_s(szADsPath,lpszExtRights,nSize);
    wcsncat_s(szADsPath,var.bstrVal,wcslen(var.bstrVal));
 
    // Get an IDirectory Object pointer to the Extended Rights Container.
    hr = ADsOpenObject(szADsPath,
               NULL,
               NULL,
               ADS_SECURE_AUTHENTICATION, // Use Secure Authentication.
               IID_IDirectoryObject,
               (void**)&amp;pExRights);
}
if (FAILED (hr) ) {
    wprintf(L&quot;Bind to Extended Rights Container failed: 0x%x\n&quot;, hr);
    goto cleanup;
}
 
// Set first attribute: CN
pAttributeEntries[0].pszAttrName = L&quot;CN&quot;;                    // Attribute name: CN
pAttributeEntries[0].dwControlCode = ADS_ATTR_APPEND;        // Add the attribute.
pAttributeEntries[0].dwADsType = ADSTYPE_CASE_IGNORE_STRING; // Attribute syntax is string.
// Fill in the ADSVALUE structure for the CN property
adsvCN.CaseIgnoreString = pszCommonName;
adsvCN.dwType = ADSTYPE_CASE_IGNORE_STRING;
pAttributeEntries[0].pADsValues = &amp;adsvCN;
pAttributeEntries[0].dwNumValues = 1;
 
// Set second attribute: objectClass
pAttributeEntries[1].pszAttrName = L&quot;objectClass&quot;;           // Attribute name: objectClass
pAttributeEntries[1].dwControlCode = ADS_ATTR_APPEND;        // Add the attribute.
pAttributeEntries[1].dwADsType = ADSTYPE_CASE_IGNORE_STRING; // Attribute syntax is string.
// Fill in the ADSVALUE structure for the objectClass property
adsvObjectClass.CaseIgnoreString = L&quot;controlAccessRight&quot;;    // objectClass is controlAccessRight
adsvObjectClass.dwType = ADSTYPE_CASE_IGNORE_STRING;
pAttributeEntries[1].pADsValues = &amp;adsvObjectClass;
pAttributeEntries[1].dwNumValues = 1;
 
// Set third attribute: appliesTo
// Each value for this property is a schemaIDGUID of a class to which the right can be applied.
pAttributeEntries[2].pszAttrName = L&quot;appliesTo&quot;;             // Attribute name: appliesTo
pAttributeEntries[2].dwControlCode = ADS_ATTR_APPEND;        // Add the attribute.
pAttributeEntries[2].dwADsType = ADSTYPE_CASE_IGNORE_STRING; // Attribute syntax is string.
// The ADSVALUE array for this property is passed in as a parameter to this function.
pAttributeEntries[2].pADsValues = pAdsvAppliesTo;
pAttributeEntries[2].dwNumValues = cAppliesTo;
 
// Set fourth attribute: displayName
pAttributeEntries[3].pszAttrName = L&quot;displayName&quot;;           // Attribute name: CNpAttributeEntries[3].dwControlCode = ADS_ATTR_APPEND;        // Add the attribute.
pAttributeEntries[3].dwADsType = ADSTYPE_CASE_IGNORE_STRING; // Attribute syntax is string.
// Fill in the ADSVALUE structure for the displayName property.
adsvDisplayName.CaseIgnoreString = pszDisplayName;
adsvDisplayName.dwType = ADSTYPE_CASE_IGNORE_STRING;
pAttributeEntries[3].pADsValues = &amp;adsvDisplayName;
pAttributeEntries[3].dwNumValues = 1;
 
// Set fifth attribute: rightsGUID
pAttributeEntries[4].pszAttrName = L&quot;rightsGUID&quot;;            // Attribute name
pAttributeEntries[4].dwControlCode = ADS_ATTR_APPEND;        // Add the attribute.
pAttributeEntries[4].dwADsType = ADSTYPE_CASE_IGNORE_STRING; // Attribute syntax is string.
// Fill in the ADSVALUE structure for the rightsGUID property.
adsvRightsGUID.dwType = ADSTYPE_CASE_IGNORE_STRING;
adsvRightsGUID.CaseIgnoreString = pszRightsGUID;
pAttributeEntries[4].pADsValues = &amp;adsvRightsGUID;
pAttributeEntries[4].dwNumValues = 1;
 
// Set sixth attribute: validAccesses
pAttributeEntries[5].pszAttrName = L&quot;validAccesses&quot;;         // Attribute name
pAttributeEntries[5].dwControlCode = ADS_ATTR_APPEND;        // Add the attribute.
pAttributeEntries[5].dwADsType = ADSTYPE_CASE_IGNORE_STRING; // Attribute syntax is string.
// Fill in the ADSVALUE structure for the rightsGUID property.
adsvValidAccesses.dwType = ADSTYPE_INTEGER;
adsvValidAccesses.Integer = ADS_RIGHT_DS_CONTROL_ACCESS;
pAttributeEntries[5].pADsValues = &amp;adsvValidAccesses;
pAttributeEntries[5].dwNumValues = 1;
 
// Set up the relative distinguished name for the new object.
wcscpy_s(pszRightRelPath, L&quot;cn=&quot;);
wcscat_s(pszRightRelPath, pszCommonName);
 
// Create the controlAccessRight
hr = pExRights-&gt;CreateDSObject(
                     pszRightRelPath,   // Relative path of new object
                     pAttributeEntries, // Attributes to be set
                     cAttributes,       // Number of attributes being set
                     &amp;pNewObject        // receives IDispatch pointer to the new object
                     );
 
cleanup:
 
if (pRootDSE)
    pRootDSE-&gt;Release();
if (pExRights)
    pExRights-&gt;Release();
if (pNewObject)
    pNewObject-&gt;Release();
if (szADsPath)
    delete [] szADsPath;
 
VariantClear(&amp;var);
return hr;
}
</code></pre>
<p>This <strong>CreateExtendedRight</strong> sample function can be called with the following code example.</p>
<pre lang="C++"><code>ADSVALUE adsvAppliesTo;
 
adsvAppliesTo.dwType = ADSTYPE_CASE_IGNORE_STRING;
adsvAppliesTo.CaseIgnoreString = L&quot;bf967aba-0de6-11d0-a285-00aa003049e2&quot;;

hr = CreateExtendedRight(L&quot;myexright&quot;, L&quot;My Extended Right&quot;,
                     L&quot;7587d479-441a-480b-9d5d-807b4d067db4&quot;,
                     &amp;adsvAppliesTo,
                     1);
</code></pre>
<p>Â </p>
<p>Â </p>
</body>
