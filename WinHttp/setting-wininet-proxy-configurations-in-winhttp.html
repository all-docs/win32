<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Setting WinINet Proxy Configurations in WinHTTP</title>
<style>
table th { border: 1px solid; }
table td { border: 1px solid; }
</style>
</head>
<body>
<hr />
<h2>description: Applications that port from WinINet to WinHTTP may need to use the same autoproxy settings that they can retrieve under WinINet or Internet Explorer (IE).
ms.assetid: c3e867d8-9d67-4e6a-8551-1fa846e089ed
title: Setting WinINet Proxy Configurations in WinHTTP
ms.topic: article
ms.date: 05/31/2018</h2>
<h1>Setting WinINet Proxy Configurations in WinHTTP</h1>
<h2>Setting Automatic Proxy on WinHTTP 5.1</h2>
<p>Applications that port from WinINet to WinHTTP may need to use the same autoproxy settings that they can retrieve under WinINet or Internet Explorer (IE). The WinHTTP version 5.1 API can retrieve and use these proxy settings. In general, WinHTTP specifies the proxy and proxy bypass servers on a per-session basis when the session is created. These settings can be overridden on a per-request basis.</p>
<p>To use the same proxy configuration as WinINet or IE, the WinHTTP client should set proxy settings for the session. In addition, if IE or WinINet are configured to use Web Proxy Auto-Discovery (WPAD), the WinHTTP client that uses those settings must set proxy settings on a per-request basis. The following sections describe how to specify the proxy settings for a session and a request:</p>
<ul>
<li><a href="#setting-the-proxy-configuration-on-a-session">Setting the Proxy Configuration on a Session</a></li>
<li><a href="#setting-the-proxy-configuration-on-a-single-request">Setting the Proxy Configuration on a Single Request</a></li>
</ul>
<h2>Setting the Proxy Configuration on a Session</h2>
<h2>The Application is Running on a User Account</h2>
<p>Before a session is created, the application calls <a href="/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser"><strong>WinHttpGetIEProxyConfigForCurrentUser</strong></a> to get the IE proxy settings. The application must be running as a user account to obtain these settings. The <em>pProxyConfig</em> parameter is a pointer to a <a href="/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config"><strong>WINHTTP_CURRENT_USER_IE_PROXY_CONFIG</strong></a> structure that contains the proxy name (<em>lpszProxy</em>) and proxy bypass (<em>lpszProxyBypass</em>) servers. The proxy name and proxy bypass values of the <strong>WINHTTP_CURRENT_USER_IE_PROXY_CONFIG</strong> structure are then used to initialize the WinHTTP session. The session is initialized by calling <a href="/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen"><strong>WinHttpOpen</strong></a> with the <em>pwszProxyName</em> and <em>pwszProxyBypass</em> parameters obtained from the <strong>lpszProxy</strong> and <strong>lpszProxyBypass</strong> members of the <strong>WINHTTP_CURRENT_USER_IE_PROXY_CONFIG</strong> structure.</p>
<h2>The Application is Running as a Service</h2>
<p>The application must ensure that the registry settings for an individual user are loaded into the registry before calling <a href="/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser"><strong>WinHttpGetIEProxyConfigForCurrentUser</strong></a>. If these settings are not loaded into the registry, <strong>WinHttpGetIEProxyConfigForCurrentUser</strong> cannot obtain the proxy settings. Registry settings for an individual user can be loaded into the registry by calling the <strong>LoadUserProfile</strong> function. If loading the user's registry settings is not an option, the application can call <a href="/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen"><strong>WinHttpOpen</strong></a> with the <strong>WINHTTP_ACCESS_TYPE_DEFAULT_PROXY</strong> specified in the <em>dwAcessType</em> parameter. Specifying the default proxy in the call to <strong>WinHttpOpen</strong> tells the WinHTTP API to retrieve the proxy configuration set by using the WinHTTP <a href="proxycfg-exe--a-proxy-configuration-tool.html"><strong>proxycfg.exe</strong></a> utility. After the registry settings for an individual user have been loaded, the application follows the steps outlined under <a href="#the-application-is-running-on-a-user-account">The application is running on a user account</a> to set the proxy name and proxy bypass servers.</p>
<h2>Setting the Proxy Configuration on a Single Request</h2>
<p>Before the session is created, the application calls <a href="/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser"><strong>WinHttpGetIEProxyConfigForCurrentUser</strong></a> to determine if WinINet and IE are configured to use WPAD. <strong>WinHttpGetIEProxyConfigForCurrentUser</strong> returns the <a href="/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config"><strong>WINHTTP_CURRENT_USER_IE_PROXY_CONFIG</strong></a> structure that contains the <strong>fAutoDetect</strong> member. A value of <strong>TRUE</strong> for this member indicates that WPAD is used, and the <strong>lpszAutoConfigUrl</strong> member contains the WPAD URL.</p>
<h2>Automatic Proxy Configuration Is Used</h2>
<p>If WPAD is used, the application calls <a href="/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl"><strong>WinHttpGetProxyForUrl</strong></a> to retrieve the proxy for the request. The <em>lpwszUrl</em> parameter contains the URL that the request is being sent to, and the <em>pAutoProxyOptions</em> parameter contains a pointer to the structure (<a href="/windows/win32/api/winhttp/ns-winhttp-winhttp_autoproxy_options"><strong>WINHTTP_AUTOPROXY_OPTIONS</strong></a>) that contains the autoproxy options. The application initializes the <strong>WINHTTP_AUTOPROXY_OPTIONS</strong> structure with the settings returned from the <a href="/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config"><strong>WINHTTP_CURRENT_USER_IE_PROXY_CONFIG</strong></a> structure in the call to <a href="/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser"><strong>WinHttpGetIEProxyConfigForCurrentUser</strong></a>. The <strong>WINHTTP_AUTOPROXY_CONFIG_URL</strong> flag is specified in the <strong>dwFlags</strong> member of the <strong>WINHTTP_AUTOPROXY_OPTIONS</strong> structure, and the <strong>lpszAutoconfigUrl</strong> member contains the proxy auto-configuration URL from the <strong>WINHTTP_CURRENT_USER_IE_PROXY_CONFIG</strong> structure. The <strong>WinHttpGetProxyForUrl</strong> function returns the proxy name and the proxy bypass list in the <strong>lpszProxy</strong> and <strong>lpszProxyBypass</strong> members of the <a href="/windows/win32/api/winhttp/ns-winhttp-winhttp_proxy_info"><strong>WINHTTP_PROXY_INFO</strong></a> structure.</p>
<p>After the proxy for the request is obtained from <a href="/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl"><strong>WinHttpGetProxyForUrl</strong></a>, the application creates the request with <a href="/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest"><strong>WinHttpOpenRequest</strong></a>. Then <a href="/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption"><strong>WinHttpSetOption</strong></a> is called to set the proxy for the request by specifying the request handle in the <em>hInternet</em> parameter. The <em>dwOption</em> parameter in the call to <strong>WinHttpSetOption</strong> should be set to <strong>WINHTTP_OPTION_PROXY</strong> and the <em>lpBuffer</em> parameter is a pointer to a <a href="/windows/win32/api/winhttp/ns-winhttp-winhttp_proxy_info"><strong>WINHTTP_PROXY_INFO</strong></a> structure that contains the proxy and proxy bypass to be used for the request.</p>
<h2>Automatic Proxy Configuration Is Not Used</h2>
<p>If the call to <a href="/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser"><strong>WinHttpGetIEProxyConfigForCurrentUser</strong></a> indicates that autoproxy is not used, the application can simply create the request with <a href="/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest"><strong>WinHttpOpenRequest</strong></a>. The proxy configuration is the same for the entire session, and per-request changes are not needed.</p>
<p>Â </p>
<p>Â </p>
</body>
