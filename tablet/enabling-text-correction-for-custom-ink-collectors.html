<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Enabling Text Correction for Custom Ink Collectors</title>
<style>
table th { border: 1px solid; }
table td { border: 1px solid; }
</style>
</head>
<body>
<hr />
<h2>description: Microsoft Tablet PC Input Panel is a powerful tool for entering handwritten text with a pen and correcting text without the use of a keyboard.
ms.assetid: c45ac1b5-7713-4bcb-a130-4692cff99aa2
title: Enabling Text Correction for Custom Ink Collectors
ms.topic: article
ms.date: 05/31/2018</h2>
<h1>Enabling Text Correction for Custom Ink Collectors</h1>
<p>Microsoft Tablet PC Input Panel is a powerful tool for entering handwritten text with a pen and correcting text without the use of a keyboard. When using Input Panel, a user enters text by handwriting onto Input Panel's inking surfaces, which causes Input Panel to recognize the user's handwriting as text. Once the text has been recognized, the user taps Insert on Input Panel to insert the text into an application or document. Prior to inserting the text, a user has access to a set of correction tools in Input Panel. These include the selection of an alternative recognition result, the ability to rewrite a single character, or even to scratch-out the entire word and rewrite. These correction tools enable a user to correct both recognition errors and human errors.</p>
<p>Once the text entered using Input Panel is in the document, users have access to the same correction functionality that is available prior to insertion in Windows <a href="/windows/desktop/TSF/text-services-framework">Text Services Framework</a>-based and Text Services-enabled applications. Starting in Microsoft Windows XP Service Pack 2 Tablet PC Edition all Rich Edit applications are Text Services-enabled by default, and starting in Windows Vista, HTML applications are Text Services-enabled by default. In-document correction is only available in Text Service based and enabled applications; this is because Input Panel is dependent on Text Service's capability to store associated text properties, including ink objects and recognition alternates, in order to provide in-document correction.</p>
<p><img src="images/a0dced5e-16de-410b-965f-5d97d297cee5.jpg" alt="tablet pc input panel with text correction" /></p>
<p>There are, however, numerous scenarios, including correcting speech recognition or correcting typed text on the go, that do not start with text entry using Input Panel but in which in-document correction can be extremely useful for Tablet PC users. A prime example is in applications that provide custom inking surfaces for entering text using a pen. Custom inking surfaces are a great way for applications to provide uniquely tailored functionality specific to the text entry tasks of each application. Additionally, custom inking surfaces provide a fully integrated Tablet PC user experience, which makes it clear the pen is a first class input device in applications that contain them. However, applications that provide custom inking surfaces may not allow or may not be able to provide the same level of correction support that is available from Input Panel in-document correction.</p>
<p><img src="images/b6797b12-dda6-44c4-87f4-570fe0c23f3a.jpg" alt="custom ink collector" /></p>
<p>Text Services based or enabled applications in which in-document correction is useful for correction of text not entered using Input Panel are able to use Input Panel's <a href="/windows/desktop/api/peninputpanel/nn-peninputpanel-ihandwrittentextinsertion"><strong>IHandWrittenTextInsertion</strong></a> API (<a href="/previous-versions/ms573516(v=vs.100)">Microsoft.TextInput.HandwrittenTextInsertion</a> class in managed code)to enable in-document correction for text entered by other means. In this way, applications can cheaply add powerful correction support to their custom inking surfaces or other text entry scenarios, and round out their Tablet PC text entry story. The Input Panel IHandWrittenTextInsertion API is included as part of the Windows Vista operating system and as part of the Tablet Platform SDK version 1.9 or newer. Both a .NET and COM based version of the API are included. Enabling in-document correction for text not entered using Input Panel is supported on Windows Vista and newer. In-document correction is only available for Latin languages and is unable to display any character outside the Latin character set.</p>
<h2>How to Use the HandwrittenTextInsertion API in an Application</h2>
<p>The required changes to an application in order to integrate Input Panel in-document correction for text not entered using Input Panel and using the <a href="/windows/desktop/api/peninputpanel/nn-peninputpanel-ihandwrittentextinsertion"><strong>IHandWrittenTextInsertion</strong></a> API are straightforward. All of the application's custom text entry code remains unchanged except for the last step. At the point at which text entered using a custom inking surface, speech recognition, or other means is to be displayed in a text services enabled text field, the application sends the text to the <strong>IHandWrittenTextInsertion</strong> interface instead of sending it directly to the text field. The Input Panel programmability component then handles inserting the text into both the text field and the Text Services backing-store. When adding the text to the Text Services backing-store, the Input Panel programmability component handles setting the text properties that are required by Input Panel for in-document correction to be enabled for that text.</p>
<p>The following section walks through this process in detail for a C++ application using the COM version of the <a href="/windows/desktop/api/peninputpanel/nn-peninputpanel-ihandwrittentextinsertion"><strong>IHandWrittenTextInsertion</strong></a> API. There are notes anywhere the steps for using the .NET Framework version of the API in C# differ for the using COM version in C++. The managed <strong>HandwrittenTextInsertion</strong> API includes a single COM interface, <strong>IHandwrittenTextInsertion</strong>. The definition for this interface is located in PenInputPanel.h and PenInputPanel_i.c.</p>
<p>First, the application should use the <a href="/windows/desktop/api/combaseapi/nf-combaseapi-cocreateinstance"><strong>CoCreateInstance</strong></a> function to produce an instance of <a href="/windows/desktop/api/peninputpanel/nn-peninputpanel-ihandwrittentextinsertion"><strong>IHandWrittenTextInsertion</strong></a> with class id <strong>CLSID_HandwrittenTextInsertion</strong>. Note that the creation of a <strong>CLSID_HandwrittenTextInsertion</strong> object will succeed only after a window is created and given focus, because until then the Text Services backing-store is not activated. Additionally, if tiptsf.dll is not present on the system, the <strong>CoCreateInstance</strong> function fails and returns <strong>REGDB_E_CLASSNOTREG</strong>, indicating that Input Panel in-document correction is not supported on the system. At this point the application should proceed without trying to enable Input Panel in-document correction. The instance of <strong>HandwrittenTextInsertion</strong> must be accessible from the application's code that handles inserting text into a text field.</p>
<blockquote>
<p>[!Note]<br />
When working with the .NET Framework version of the API, the application should add a using statement to allow access to the <a href="/previous-versions/dotnet/netframework-3.5/ms581554(v=vs.90)">Microsoft.Ink.TextInput</a> namespace and then create the object directly.</p>
</blockquote>
<p>Â </p>
<p>Second, the application's code that is responsible for inserting text into a text field must be altered so that it no longer inserts text into a text field directly, but calls one or the other of <a href="/windows/desktop/api/peninputpanel/nn-peninputpanel-ihandwrittentextinsertion"><strong>IHandwrittenTextInsertion</strong></a>'s two insertion methods instead. Whether the applications should choose to call <a href="/windows/desktop/api/peninputpanel/nf-peninputpanel-ihandwrittentextinsertion-insertrecognitionresultsarray"><strong>InsertRecognitionResultsArray</strong></a> or <a href="/windows/desktop/api/peninputpanel/nf-peninputpanel-ihandwrittentextinsertion-insertinkrecognitionresult"><strong>InsertRecognitionResults</strong></a> depends on whether the application has the recognition alternates for the text stored as an array or as an <a href="/windows/desktop/api/msinkaut/nn-msinkaut-iinkrecognitionresult"><strong>IInkRecognitionResult</strong></a> object.</p>
<blockquote>
<p>[!Note]<br />
When working in managed code, the corresponding recognition object consumed by InsertRecognitionResultsArray is <a href="/previous-versions/ms552537(v=vs.100)">RecognitionResult</a>. Both methods consume the following three parameters:</p>
</blockquote>
<p>Â </p>
<ul>
<li><em>alternates</em> Is a two dimensional collection of strings, stored either as an array of arrays or as an <a href="/windows/desktop/api/msinkaut/nn-msinkaut-iinkrecognitionresult"><strong>IInkRecognitionResult</strong></a> (or <a href="/previous-versions/ms552537(v=vs.100)">RecognitionResult</a>) object. If the alternates are stored as an array of arrays, then it should be passed as a safe array pointer. Each entry in the top level array is a list of alternates for a single word in the insertion. The entry at position zero in the sub-arrays of alternates is the text that is inserted into the text field. The additional alternates (indices 1 through n in each sub-array) are stored in the Text Services backing-store and offered to the user as choices as part of in-document correction. If alternates are not included, then the user sees 'No suggestion' in place of the list of alternates. If an insertion contains multiple words with spaces between them, then each space must be included as an entry in the top level array.</li>
<li><em>language</em> The Input Language <a href="/previous-versions/ms221397(v=vs.71)">LCID</a> that corresponds to the text contained in the <em>alternates</em> parameter. In the case in which the contents of <em>alternates</em> was generated by a handwriting or speech recognizer, this is also the <a href="/windows/desktop/api/msinkaut/nf-msinkaut-iinkrecognizer-get_languages"><strong>Languages</strong></a> property associated with the recognizer used.</li>
<li><em>fLatticeContainsAutoSpacingInformation</em> A flag indicating whether the text contained in the <em>alternates</em> parameter was generated by a recognizer with auto-spacing enabled. If auto-spacing was enabled, then the flag should be set to <strong>TRUE</strong>. If auto-spacing was disabled, then the flag should be set to <strong>FALSE</strong>. In the case in which the contents of <em>alternates</em> was generated by a recognizer that does not support auto-spacing, or was not generated by a recognizer at all, then the flag should be set to <strong>FALSE</strong>.</li>
</ul>
<p>Input Panel's programmability model is able to insert the text in the document or application from the position of the system caret.</p>
<p>Both methods return <strong>S_OK</strong> if the insertion succeeds. They return <strong>E_NOINTERFACE</strong> if the application is not Text Services based or enabled, and <strong>E_INVALIDARG</strong> if <em>alternates</em> is improperly formatted or inaccessible. They may also return <strong>E_OUTOFMEMORY</strong> if there is not enough memory available on the system, or <strong>E_FAIL</strong> after a catastrophic failure such as the Text Services Framework not being enabled.</p>
<h3>Conclusion</h3>
<p>Enabling Input Panel in-document correction for text not entered using Input Panel is a cheap and easy way for a Text Services based or enabled application to supplement a custom inking or input method with powerful pen-based correction functionality. On Windows Vista, all Rich Edit and Trident applications are Text Services enabled. While integrated inking surfaces are a great option for adding a custom Tablet PC user experience to an application, they only support half of text entry if they do not include correction capabilities. In-document correction provides users with the other half of the story by adding the ability to swap a selection for a recognition alternate, or to rewrite part or all of the selection.</p>
<h2>Related topics</h2>
<!-- raw HTML omitted -->
<p><a href="programming-the-text-input-panel.html">Programming the Text Input Panel</a></p>
<!-- raw HTML omitted -->
<p>Â </p>
<p>Â </p>
</body>
