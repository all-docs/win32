<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>AcceptSecurityContext (General) function</title>
<style>
table th { border: 1px solid; }
table td { border: 1px solid; }
</style>
</head>
<body>
<hr />
<h2>description: Enables the server component of a transport application to establish a security context between the server and a remote client.
ms.assetid: eaa15fed-4438-4e43-9be3-aa100ca453c7
title: AcceptSecurityContext (General) function (Sspi.h)
ms.topic: reference
ms.date: 03/17/2023</h2>
<h1>AcceptSecurityContext (General) function</h1>
<p>The <strong>AcceptSecurityContext (General)</strong> function enables the server component of a transport application to establish a <a href="../secgloss/s-gly.html">security context</a> between the server and a remote client. The remote client uses the <a href="initializesecuritycontext--general.html">InitializeSecurityContext (General)</a> function to start the process of establishing a <a href="../secgloss/s-gly.html">security context</a>. The server can require one or more reply tokens from the remote client to complete establishing the <a href="../secgloss/s-gly.html">security context</a>.</p>
<p>For information about using this function with a specific <a href="../secgloss/s-gly.html">security support provider</a> (SSP), see the following topics.</p>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="acceptsecuritycontext--credssp.html"><strong>AcceptSecurityContext (CredSSP)</strong></a></td>
<td>Allows the server component of a transport application establish a <a href="../secgloss/s-gly.html">security context</a> between the server and a remote client by using Credential Security Support Provider (CredSSP).</td>
</tr>
<tr>
<td><a href="acceptsecuritycontext--digest.html"><strong>AcceptSecurityContext (Digest)</strong></a></td>
<td>Enables the server component of a transport application to establish a <a href="../secgloss/s-gly.html">security context</a> between the server and a remote client that is using Digest.</td>
</tr>
<tr>
<td><a href="acceptsecuritycontext--kerberos.html"><strong>AcceptSecurityContext (Kerberos)</strong></a></td>
<td>Enables the server component of a transport application to establish a <a href="../secgloss/s-gly.html">security context</a> between the server and a remote client that is using Kerberos.</td>
</tr>
<tr>
<td><a href="acceptsecuritycontext--negotiate.html"><strong>AcceptSecurityContext (Negotiate)</strong></a></td>
<td>Enables the server component of a transport application to establish a <a href="../secgloss/s-gly.html">security context</a> between the server and a remote client that is using Negotiate.</td>
</tr>
<tr>
<td><a href="acceptsecuritycontext--ntlm.html"><strong>AcceptSecurityContext (NTLM)</strong></a></td>
<td>Enables the server component of a transport application to establish a <a href="../secgloss/s-gly.html">security context</a> between the server and a remote client that is using NTLM.</td>
</tr>
<tr>
<td><a href="acceptsecuritycontext--schannel.html"><strong>AcceptSecurityContext (Schannel)</strong></a></td>
<td>Enables the server component of a transport application to establish a <a href="../secgloss/s-gly.html">security context</a> between the server and a remote client that is using Schannel.</td>
</tr>
</tbody>
</table>
<h2>Syntax</h2>
<pre lang="C++"><code>SECURITY_STATUS SEC_Entry AcceptSecurityContext(
  _In_opt_    PCredHandle    phCredential,
  _Inout_opt_ PCtxtHandle    phContext,
  _In_opt_    PSecBufferDesc pInput,
  _In_        ULONG          fContextReq,
  _In_        ULONG          TargetDataRep,
  _Inout_opt_ PCtxtHandle    phNewContext,
  _Inout_opt_ PSecBufferDesc pOutput,
  _Out_       PULONG         pfContextAttr,
  _Out_opt_   PTimeStamp     ptsExpiry
);
</code></pre>
<h2>Parameters</h2>
<p><em>phCredential</em> <code>[in, optional]</code></p>
<p>A handle to the credentials of the server. The server calls the <a href="acquirecredentialshandle--general.html">AcquireCredentialsHandle (General)</a> function with either the SECPKG_CRED_INBOUND or SECPKG_CRED_BOTH flag set to retrieve this handle.</p>
<p><em>phContext</em> <code>[in, out]</code></p>
<p>A pointer to a <a href="sspi-handles.html">CtxtHandle</a> structure. On the first call to <strong>AcceptSecurityContext (General)</strong>, this pointer is <code>NULL</code>. On subsequent calls, <em>phContext</em> is the handle to the partially formed context that was returned in the <em>phNewContext</em> parameter by the first call.</p>
<blockquote>
<p>[!WARNING]
Do not use the same context handle in concurrent calls to <strong>AcceptSecurityContext (General)</strong>. The API implementation in the security service providers is not thread-safe.</p>
</blockquote>
<p><em>pInput</em> <code>[in, optional]</code></p>
<p>A pointer to a <a href="/windows/win32/api/sspi/ns-sspi-secbufferdesc">SecBufferDesc</a> structure generated by a client call to <a href="initializesecuritycontext--general.html">InitializeSecurityContext (General)</a> that contains the input buffer descriptor.</p>
<p>When using the Schannel SSP, the first buffer must be of type SECBUFFER_TOKEN and contain the security token received from the client. The second buffer should be of type SECBUFFER_EMPTY.</p>
<p>When using the Negotiate, Kerberos, or NTLM SSPs, channel binding information can be specified by passing in a <a href="/windows/win32/api/sspi/ns-sspi-secbuffer">SecBuffer</a> structure of type <strong>SECBUFFER_CHANNEL_BINDINGS</strong> in addition to the buffers generated by the call to the <a href="initializesecuritycontext--general.html">InitializeSecurityContext (General)</a> function. The channel binding information for the channel binding buffer can be obtained by calling the <a href="querycontextattributes--schannel.html">QueryContextAttributes (Schannel)</a> function on the Schannel context the client used to authenticate.</p>
<p><em>fContextReq</em> <code>[in]</code></p>
<p>Bit flags that specify the attributes required by the server to establish the context. Bit flags can be combined by using bitwise-<strong>OR</strong> operations. This parameter can be one or more of the following values.</p>
<table>
<thead>
<tr>
<th>Value</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ASC_REQ_ALLOCATE_MEMORY</strong></td>
<td>Digest and Schannel will allocate output buffers for you. When you have finished using the output buffers, free them by calling the <a href="/windows/win32/api/sspi/nf-sspi-freecontextbuffer"><strong>FreeContextBuffer</strong></a> function.</td>
</tr>
<tr>
<td><strong>ASC_REQ_ALLOW_MISSING_BINDINGS</strong></td>
<td>Indicates that Digest does not require channel bindings for both inner and outer channels. This value is used for backward compatibility when support for endpoint channel binding is not known.<!-- raw HTML omitted --> This value is mutually exclusive with <strong>ASC_REQ_PROXY_BINDINGS</strong>.<!-- raw HTML omitted --> This value is supported only by the Digest SSP.<!-- raw HTML omitted --> <strong>Windows ServerÂ 2008, WindowsÂ Vista, Windows ServerÂ 2003 and WindowsÂ XP:</strong> This value is not supported.</td>
</tr>
<tr>
<td><strong>ASC_REQ_CONFIDENTIALITY</strong></td>
<td>Encrypt and decrypt messages. <!-- raw HTML omitted --> The Digest SSP supports this flag for SASL only.</td>
</tr>
<tr>
<td><strong>ASC_REQ_CONNECTION</strong></td>
<td>The <a href="../secgloss/s-gly.html">security context</a> will not handle formatting messages.</td>
</tr>
<tr>
<td><strong>ASC_REQ_DELEGATE</strong></td>
<td>The server is allowed to impersonate the client. Valid for Kerberos. Ignore this flag for <a href="../secgloss/c-gly.html">constrained delegation</a>.</td>
</tr>
<tr>
<td><strong>ASC_REQ_EXTENDED_ERROR</strong></td>
<td>When errors occur, the remote party will be notified.</td>
</tr>
<tr>
<td><strong>ASC_REQ_HTTP (0x10000000)</strong></td>
<td>Use Digest for HTTP. Omit this flag to use Digest as an SASL mechanism.</td>
</tr>
<tr>
<td><strong>ASC_REQ_INTEGRITY</strong></td>
<td>Sign messages and verify signatures.<!-- raw HTML omitted --> Schannel does not support this flag.</td>
</tr>
<tr>
<td><strong>ASC_REQ_MUTUAL_AUTH</strong></td>
<td>The client is required to supply a certificate to be used for client authentication.<!-- raw HTML omitted --> This flag is supported only by Schannel.</td>
</tr>
<tr>
<td><strong>ASC_REQ_PROXY_BINDINGS</strong></td>
<td>Indicates that Digest requires channel binding.<!-- raw HTML omitted --> This value is mutually exclusive with <strong>ASC_REQ_ALLOW_MISSING_BINDINGS</strong>.<!-- raw HTML omitted --> This value is supported only by the Digest SSP.<!-- raw HTML omitted --> <strong>Windows ServerÂ 2008, WindowsÂ Vista, Windows ServerÂ 2003 and WindowsÂ XP:</strong> This value is not supported.</td>
</tr>
<tr>
<td><strong>ASC_REQ_REPLAY_DETECT</strong></td>
<td>Detect replayed packets.</td>
</tr>
<tr>
<td><strong>ASC_REQ_SEQUENCE_DETECT</strong></td>
<td>Detect messages received out of sequence.</td>
</tr>
<tr>
<td><strong>ASC_REQ_STREAM</strong></td>
<td>Support a stream-oriented connection.<!-- raw HTML omitted --> This flag is supported only by Schannel.</td>
</tr>
</tbody>
</table>
<p>For possible attribute flags and their meanings, see <a href="context-requirements.html">Context Requirements</a>. Flags used for this parameter are prefixed with ASC_REQ, for example, ASC_REQ_DELEGATE.</p>
<p>The requested attributes may not be supported by the client. For more information, see the <em>pfContextAttr</em> parameter.</p>
<p><em>TargetDataRep</em> <code>[in]</code></p>
<p>The data representation, such as byte ordering, on the target. This parameter can be either SECURITY_NATIVE_DREP or SECURITY_NETWORK_DREP.</p>
<p>This parameter is not used with Schannel or Digest SSPs. When you use Schannel or Digest SSPs, specify zero for this parameter.</p>
<p><em>phNewContext</em> <code>[in, out, optional]</code></p>
<p>A pointer to a <a href="sspi-handles.html">CtxtHandle</a> structure. On the first call to <strong>AcceptSecurityContext (General)</strong>, this pointer receives the new context handle. On subsequent calls, <em>phNewContext</em> can be the same as the handle specified in the <em>phContext</em> parameter. <em>phNewContext</em> should never be <code>NULL</code>.</p>
<p><em>pOutput</em> <code>[in, out, optional]</code></p>
<p>A pointer to a <a href="/windows/win32/api/sspi/ns-sspi-secbufferdesc">SecBufferDesc</a> structure that contains the output buffer descriptor. This buffer is sent to the client for input into additional calls to <a href="initializesecuritycontext--general.html">InitializeSecurityContext (General)</a>. An output buffer may be generated even if the function returns SEC_E_OK. Any buffer generated must be sent back to the client application.</p>
<p>When using Schannel, on output, this buffer receives a token for the <a href="../secgloss/s-gly.html">security context</a>. The token must be sent to the client. The function can also return a buffer of type SECBUFFER_EXTRA. In addition, the caller must pass in a buffer of type <strong>SECBUFFER_ALERT</strong>. On output, if an alert is generated, this buffer contains information about that alert, and the function fails.</p>
<p><em>pfContextAttr</em> <code>[out]</code></p>
<p>A pointer to a variable that receives a set of bit flags that indicate the attributes of the established context. For a description of the various attributes, see <a href="context-requirements.html">Context Requirements</a>. Flags used for this parameter are prefixed with ASC_RET, for example, ASC_RET_DELEGATE.</p>
<p>Do not check for security-related attributes until the final function call returns successfully. Attribute flags not related to security, such as the ASC_RET_ALLOCATED_MEMORY flag, can be checked before the final return.</p>
<p><em>ptsTimeStamp</em> <code>[out, optional]</code></p>
<p>A pointer to a <a href="timestamp.html">TimeStamp</a> structure that receives the expiration time of the context. We recommend that the <a href="../secgloss/s-gly.html">security package</a> always return this value in local time.</p>
<p>This parameter is set to a constant maximum time. There is no expiration time for Digest <a href="../secgloss/s-gly.html">security context</a>s or credentials or when using the Digest SSP.</p>
<p>This is optional when using the Schannel SSP. When the remote party has supplied a certificate to be used for authentication, this parameter receives the expiration time for that certificate. If no certificate was supplied, a maximum time value is returned.</p>
<blockquote>
<p>[!NOTE]
Until the last call of the authentication process, the expiration time for the context can be incorrect because more information will be provided during later stages of the negotiation. Therefore, <em>ptsTimeStamp</em> must be <code>NULL</code> until the last call to the function.</p>
</blockquote>
<h2>Return value</h2>
<p>This function returns one of the following values.</p>
<!-- raw HTML omitted -->
<h2>Remarks</h2>
<p>The <strong>AcceptSecurityContext (General)</strong> function is the server counterpart to the <a href="initializesecuritycontext--general.html">InitializeSecurityContext (General)</a> function.</p>
<p>When the server receives a request from a client, the server uses the <em>fContextReq</em> parameter to specify what it requires of the session. In this fashion, a server can specify that clients must be capable of using a confidential or <a href="../secgloss/i-gly.html">integrity</a>-checked session, and it can reject clients that cannot meet that demand. Alternatively, a server can require nothing, and whatever the client can provide or requires is returned in the <em>pfContextAttr</em> parameter.</p>
<p>For a package that supports multiple-leg authentication, such as mutual authentication, the calling sequence is as follows:</p>
<ol>
<li>The client transmits a token to the server.</li>
<li>The server calls <strong>AcceptSecurityContext (General)</strong> the first time, which generates a reply token that is then sent to the client.</li>
<li>The client receives the token and passes it to <a href="initializesecuritycontext--general.html">InitializeSecurityContext (General)</a>. If <strong>InitializeSecurityContext (General)</strong> returns SEC_E_OK, mutual authentication has been completed and a secure session can begin. If <strong>InitializeSecurityContext (General)</strong> returns an error code, the mutual authentication negotiation ends. Otherwise, the security token returned by <strong>InitializeSecurityContext (General)</strong> is sent to the client, and steps 2 and 3 are repeated.</li>
<li>Do not use the <em>phContext</em> value in concurrent calls to <strong>AcceptSecurityContext (General)</strong>. The implementation in the security providers is not thread-safe.</li>
</ol>
<p>The <em>fContextReq</em> and <em>pfContextAttr</em> parameters are bitmasks that represent various context attributes. For a description of the various attributes, see <a href="context-requirements.html">Context Requirements</a>.</p>
<blockquote>
<p>[!NOTE]
The <em>pfContextAttr</em> parameter is valid on any successful return, but only on the final successful return should you examine the flags pertaining to security aspects of the context. Intermediate returns can set, for example, the ISC_RET_ALLOCATED_MEMORY flag.</p>
</blockquote>
<p>The caller is responsible for determining whether the final context attributes are sufficient. If, for example, confidentiality (encryption) was requested, but could not be established, some applications may choose to shut down the connection immediately. If the <a href="../secgloss/s-gly.html">security context</a> cannot be established, the server must free the partially created context by calling the <a href="/windows/win32/api/sspi/nf-sspi-deletesecuritycontext">DeleteSecurityContext</a> function. For information about when to call the <strong>DeleteSecurityContext</strong> function, see <strong>DeleteSecurityContext</strong>.</p>
<p>After the <a href="../secgloss/s-gly.html">security context</a> has been established, the server application can use the <a href="/windows/win32/api/sspi/nf-sspi-querysecuritycontexttoken">QuerySecurityContextToken</a> function to retrieve a handle to the user account to which the client certificate was mapped. Also, the server can use the <a href="/windows/win32/api/sspi/nf-sspi-impersonatesecuritycontext">ImpersonateSecurityContext</a> function to impersonate the user.</p>
<h2>Requirements</h2>
<table>
<thead>
<tr>
<th>Requirement</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Minimum supported client</td>
<td>WindowsÂ XP [desktop apps only]</td>
</tr>
<tr>
<td>Minimum supported server</td>
<td>Windows ServerÂ 2003 [desktop apps only]</td>
</tr>
<tr>
<td>Header</td>
<td>Sspi.h (include Security.h)</td>
</tr>
<tr>
<td>Library</td>
<td>Secur32.lib</td>
</tr>
<tr>
<td>DLL</td>
<td>Secur32.dll</td>
</tr>
</tbody>
</table>
<h2>See also</h2>
<p><a href="authentication-functions.md#sspi-functions">SSPI Functions</a></p>
<p><a href="/windows/win32/api/sspi/nf-sspi-deletesecuritycontext">DeleteSecurityContext</a></p>
<p><a href="initializesecuritycontext--general.html">InitializeSecurityContext (General)</a></p>
</body>
