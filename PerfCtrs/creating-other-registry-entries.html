<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Creating Other Registry Entries</title>
<style>
table th { border: 1px solid; }
table td { border: 1px solid; }
</style>
</head>
<body>
<hr />
<h2>description: The performance DLLs OpenPerformanceData function takes a string argument as input.
ms.assetid: 8ec0ea45-5789-4801-b486-555779a7303e
title: Creating Other Registry Entries
ms.topic: article
ms.date: 05/31/2018</h2>
<h1>Creating Other Registry Entries</h1>
<p>As described in <a href="./creating-the-applications-performance-key.html">Creating the Application's Performance Key</a>, a component that provides performance counter data must have a <strong>Performance</strong> key under the <strong>Services</strong> key, and the <strong>Performance</strong> key must contain <strong>Library</strong>, <strong>Open</strong>, <strong>Collect</strong>, and <strong>Close</strong> values. In certain cases, your component may need to configure additional registry values.</p>
<h2>Metadata</h2>
<p><code>MetadataGlobal</code> and <code>MetadataCostly</code> are metadata-only queries generated by Windows 10 20H1 and later. They allow a user to obtain metadata (object information and counter information) without performing a potentially-expensive data collection. The metadata-only query is expected to return the same results as the corresponding <code>Global</code> or <code>Costly</code> query except that <code>NumInstances</code> should be set to <code>PERF_METADATA_MULTIPLE_INSTANCES</code> (for a multi-instance object) or <code>PERF_METADATA_NO_INSTANCES</code> (for a single-instance object) and the result should omit all <code>PERF_INSTANCE_DEFINITION</code> blocks.</p>
<p>If your performance DLL supports <code>MetadataGlobal</code> and <code>MetadataCostly</code> query types, it should indicate this by adding a <code>REG_DWORD</code> value <code>Collect Supports Metadata</code> to its <code>Performance</code> key and setting the value to 1. If <code>Collect Supports Metadata</code> is absent or set to 0, a metadata-only query will fall-back to a <code>Global</code> or <code>Costly</code> query.</p>
<pre><code>HKEY_LOCAL_MACHINE
Â Â Â \SYSTEM
Â Â Â Â Â Â \CurrentControlSet
Â Â Â Â Â Â Â Â Â \Services
Â Â Â Â Â Â Â Â Â Â Â Â \application-name
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \Performance
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Collect Supports Metadata = 1
</code></pre>
<h2>Linkage</h2>
<p>The performance DLL's <a href="/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)"><strong>OpenPerformanceData</strong></a> function takes a string argument as input. To provide an input string to your open function, include a <strong>Linkage</strong> key under your <strong>Services</strong> key. The <strong>Linkage</strong> key contains an <strong>Export</strong> value. Set the value data for <strong>Export</strong> to the input string that you want to pass to your open function. The data type of <strong>Export</strong> is <strong>REG_MULTI_SZ</strong>.</p>
<p>If <strong>Export</strong> is not defined (<strong>Export</strong> is optional), the system passes <strong>NULL</strong> to your <a href="/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)"><strong>OpenPerformanceData</strong></a> function.</p>
<p>Typically, if more than one application shares the same performance DLL, each application includes a <strong>Linkage</strong> key and <strong>Export</strong> value to provide context as to which application is calling the DLL.</p>
<p>The following shows the registry entries:</p>
<pre><code>HKEY_LOCAL_MACHINE
Â Â Â \SYSTEM
Â Â Â Â Â Â \CurrentControlSet
Â Â Â Â Â Â Â Â Â \Services
Â Â Â Â Â Â Â Â Â Â Â Â \application-name-1
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \Linkage
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Export = app-1 context strings
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \Performance
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Library = perfctrs.dll
Â Â Â Â Â Â Â Â Â Â Â Â \application-name-2
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \Linkage
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Export = app-2 context strings
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \Performance
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Library = perfctrs.dll
</code></pre>
<h2>Timeout</h2>
<p>By default, the performance DLL's <a href="/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)"><strong>OpenPerformanceData</strong></a> and <a href="/windows/win32/api/winperf/nc-winperf-pm_collect_proc"><strong>CollectPerformanceData</strong></a> functions must return within 10,000 milliseconds. If not, the system does not use the data that the DLL returns. The application can increase or decrease the timeout value by specifying an <strong>Open Timeout</strong> or <strong>Collect Timeout</strong> registry value under their <strong>Performance</strong> key as shown in the following example.</p>
<pre><code>HKEY_LOCAL_MACHINE
Â Â Â \SYSTEM
Â Â Â Â Â Â \CurrentControlSet
Â Â Â Â Â Â Â Â Â \Services
Â Â Â Â Â Â Â Â Â Â Â Â \application-name
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \Performance
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Open Timeout = Timeout value for your open function, in milliseconds
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Collect Timeout = Timeout value for your collect function, in milliseconds
</code></pre>
<h2>DOS Devices</h2>
<p>To obtain the performance data for some applications (those that return counters using the <a href="/windows/desktop/api/ioapiset/nf-ioapiset-deviceiocontrol"><strong>DeviceIoControl</strong></a> function), it is necessary to use the <a href="/windows/desktop/api/fileapi/nf-fileapi-createfilea"><strong>CreateFile</strong></a> function to open the device associated with the application. In this case, the name specified in <strong>CreateFile</strong> must also be installed in the DOS Devices node of the registry, as shown here:</p>
<pre><code>HKEY_LOCAL_MACHINE
Â Â Â \SYSTEM
Â Â Â Â Â Â \CurrentControlSet
Â Â Â Â Â Â Â Â Â \Control
Â Â Â Â Â Â Â Â Â Â Â Â \Session Manager
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \DOS Devices
</code></pre>
</body>
