<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>CSourceSeeking class</title>
<style>
table th { border: 1px solid; }
table td { border: 1px solid; }
</style>
</head>
<body>
<hr />
<p>description: The CSourceSeeking class is an abstract class for implementing seeking in source filters with one output pin.
ms.assetid: 46e711e1-78d4-4e83-9df1-06032edeba6a
title: CSourceSeeking class (Ctlutil.h)
ms.topic: reference
ms.date: 4/26/2023
topic_type:</p>
<ul>
<li>APIRef</li>
<li>kbSyntax
api_name:</li>
<li>CSourceSeeking
api_type:</li>
<li>COM
api_location:</li>
<li>Strmbase.lib</li>
<li>Strmbase.dll</li>
<li>Strmbasd.lib</li>
<li>Strmbasd.dll
ms.custom: UpdateFrequency5</li>
</ul>
<hr />
<h1>CSourceSeeking class</h1>
<p>[The feature associated with this page, <a href="/windows/win32/directshow/directshow">DirectShow</a>, is a legacy feature. It has been superseded by <a href="/uwp/api/Windows.Media.Playback.MediaPlayer">MediaPlayer</a>, <a href="/windows/win32/api/mfmediaengine/nn-mfmediaengine-imfmediaengine">IMFMediaEngine</a>, and <a href="/windows/win32/medfound/audio-video-capture-in-media-foundation">Audio/Video Capture in Media Foundation</a>. Those features have been optimized for Windows 10 and Windows 11. Microsoft strongly recommends that new code use <strong>MediaPlayer</strong>, <strong>IMFMediaEngine</strong> and <strong>Audio/Video Capture in Media Foundation</strong> instead of <strong>DirectShow</strong>, when possible. Microsoft suggests that existing code that uses the legacy APIs be rewritten to use the new APIs if possible.]</p>
<p><img src="images/cutil15.png" alt="csourceseeking class hierarchy" /></p>
<p>The <strong>CSourceSeeking</strong> class is an abstract class for implementing seeking in source filters with one output pin.</p>
<p>This class supports the <a href="/windows/desktop/api/Strmif/nn-strmif-imediaseeking"><strong>IMediaSeeking</strong></a> interface. It provides default implementations for all of the <strong>IMediaSeeking</strong> methods. Protected member variables store the start time, stop time, and current rate. By default, the only time format supported by the class is <strong>TIME_FORMAT_MEDIA_TIME</strong> (100-nanosecond units). See Remarks for more information.</p>
<table>
<thead>
<tr>
<th>Protected Member Variables</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="csourceseeking-m-rtduration.html"><strong>m_rtDuration</strong></a></td>
<td>Duration of the stream.</td>
</tr>
<tr>
<td><a href="csourceseeking-m-rtstart.html"><strong>m_rtStart</strong></a></td>
<td>Start time.</td>
</tr>
<tr>
<td><a href="csourceseeking-m-rtstop.html"><strong>m_rtStop</strong></a></td>
<td>Stop time.</td>
</tr>
<tr>
<td><a href="csourceseeking-m-drateseeking.html"><strong>m_dRateSeeking</strong></a></td>
<td>Playback rate.</td>
</tr>
<tr>
<td><a href="csourceseeking-m-dwseekingcaps.html"><strong>m_dwSeekingCaps</strong></a></td>
<td>Seeking capabilities.</td>
</tr>
<tr>
<td><a href="csourceseeking-m-plock.html"><strong>m_pLock</strong></a></td>
<td>Pointer to a critical section object for locking.</td>
</tr>
<tr>
<td>Protected Methods</td>
<td>Description</td>
</tr>
<tr>
<td><a href="csourceseeking-csourceseeking.html"><strong>CSourceSeeking</strong></a></td>
<td>Constructor method.</td>
</tr>
<tr>
<td>Pure Virtual Methods</td>
<td>Description</td>
</tr>
<tr>
<td><a href="csourceseeking-changerate.html"><strong>ChangeRate</strong></a></td>
<td>Called when the playback rate changes.</td>
</tr>
<tr>
<td><a href="csourceseeking-changestart.html"><strong>ChangeStart</strong></a></td>
<td>Called when the start position changes.</td>
</tr>
<tr>
<td><a href="csourceseeking-changestop.html"><strong>ChangeStop</strong></a></td>
<td>Called when the stop position changes.</td>
</tr>
<tr>
<td>IMediaSeeking Methods</td>
<td>Description</td>
</tr>
<tr>
<td><a href="csourceseeking-isformatsupported.html"><strong>IsFormatSupported</strong></a></td>
<td>Determines whether a specified time format is supported.</td>
</tr>
<tr>
<td><a href="csourceseeking-querypreferredformat.html"><strong>QueryPreferredFormat</strong></a></td>
<td>Retrieves the object's preferred time format.</td>
</tr>
<tr>
<td><a href="csourceseeking-settimeformat.html"><strong>SetTimeFormat</strong></a></td>
<td>Sets the time format.</td>
</tr>
<tr>
<td><a href="csourceseeking-isusingtimeformat.html"><strong>IsUsingTimeFormat</strong></a></td>
<td>Determines whether a specified time format is the format currently in use.</td>
</tr>
<tr>
<td><a href="csourceseeking-gettimeformat.html"><strong>GetTimeFormat</strong></a></td>
<td>Retrieves the current time format.</td>
</tr>
<tr>
<td><a href="csourceseeking-getduration.html"><strong>GetDuration</strong></a></td>
<td>Retrieves the duration of the stream.</td>
</tr>
<tr>
<td><a href="csourceseeking-getstopposition.html"><strong>GetStopPosition</strong></a></td>
<td>Retrieves the time at which the playback will stop, relative to the duration of the stream.</td>
</tr>
<tr>
<td><a href="csourceseeking-getcurrentposition.html"><strong>GetCurrentPosition</strong></a></td>
<td>Retrieves the current position, relative to the total duration of the stream.</td>
</tr>
<tr>
<td><a href="csourceseeking-getcapabilities.html"><strong>GetCapabilities</strong></a></td>
<td>Retrieves all the seeking capabilities of the stream.</td>
</tr>
<tr>
<td><a href="csourceseeking-checkcapabilities.html"><strong>CheckCapabilities</strong></a></td>
<td>Queries whether the stream has specified seeking capabilities.</td>
</tr>
<tr>
<td><a href="csourceseeking-converttimeformat.html"><strong>ConvertTimeFormat</strong></a></td>
<td>Converts from one time format to another.</td>
</tr>
<tr>
<td><a href="csourceseeking-setpositions.html"><strong>SetPositions</strong></a></td>
<td>Sets the current position and the stop position.</td>
</tr>
<tr>
<td><a href="csourceseeking-getpositions.html"><strong>GetPositions</strong></a></td>
<td>Retrieves the current position and the stop position.</td>
</tr>
<tr>
<td><a href="csourceseeking-getavailable.html"><strong>GetAvailable</strong></a></td>
<td>Retrieves the range of times in which seeking is efficient.</td>
</tr>
<tr>
<td><a href="csourceseeking-setrate.html"><strong>SetRate</strong></a></td>
<td>Sets the playback rate.</td>
</tr>
<tr>
<td><a href="csourceseeking-getrate.html"><strong>GetRate</strong></a></td>
<td>Retrieves the playback rate.</td>
</tr>
<tr>
<td><a href="csourceseeking-getpreroll.html"><strong>GetPreroll</strong></a></td>
<td>Retrieves the preroll time.</td>
</tr>
</tbody>
</table>
<h2>Remarks</h2>
<p>Whenever the start position, stop position, or playback rate changes, the <strong>CSourceSeeking</strong> object calls a corresponding pure virtual method:</p>
<ul>
<li>Start position: <a href="csourceseeking-changestart.html"><strong>CSourceSeeking::ChangeStart</strong></a></li>
<li>Stop position: <a href="csourceseeking-changestop.html"><strong>CSourceSeeking::ChangeStop</strong></a></li>
<li>Playback rate: <a href="csourceseeking-changerate.html"><strong>CSourceSeeking::ChangeRate</strong></a></li>
</ul>
<p>The derived class must implement these methods. After any seek operation, a filter must do the following:</p>
<ol>
<li>Call the <a href="/windows/desktop/api/Strmif/nf-strmif-ipin-beginflush"><strong>IPin::BeginFlush</strong></a> method on the downstream input pin.</li>
<li>Halt the worker thread that is delivering data.</li>
<li>Call the <a href="/windows/desktop/api/Strmif/nf-strmif-ipin-endflush"><strong>IPin::EndFlush</strong></a> method on the input pin.</li>
<li>Restart the worker thread.</li>
<li>Call the <a href="/windows/desktop/api/Strmif/nf-strmif-ipin-newsegment"><strong>IPin::NewSegment</strong></a> method on the input pin.</li>
<li>Set the discontinuity property on the first sample. Call the <a href="/windows/desktop/api/Strmif/nf-strmif-imediasample-setdiscontinuity"><strong>IMediaSample::SetDiscontinuity</strong></a> method.</li>
</ol>
<p>The call to <a href="/windows/desktop/api/Strmif/nf-strmif-ipin-beginflush"><strong>BeginFlush</strong></a> frees the worker thread, if the thread is blocked waiting to deliver a sample.</p>
<p>In step 2, make sure that the thread has stopped sending data. Depending on the implementation, you might need to wait for the thread to exit, or for the thread to signal a response of some kind. If your filter uses the <a href="csourcestream.html"><strong>CSourceStream</strong></a> class, the <a href="csourcestream-stop.html"><strong>CSourceStream::Stop</strong></a> method blocks until the worker thread replies.</p>
<p>Ideally, the new segment (step 5) should be delivered from the worker thread. It can also be done by the <strong>CSourceSeeking</strong> object, as long as the filter serializes it with the samples.</p>
<p>The following example shows a possible implementation. It assumes that the source filter's output pin is derived from <strong>CSourceSeeking</strong> and <a href="csourcestream.html"><strong>CSourceStream</strong></a>. This example defines a helper method, UpdateFromSeek, that performs steps 1 4. The <a href="csourcestream-onthreadstartplay.html"><strong>CSourceStream::OnThreadStartPlay</strong></a> method is overridden to send the new segment, and to set a flag indicating the discontinuity. The worker thread picks up this flag and calls the <a href="/windows/desktop/api/Strmif/nf-strmif-imediasample-setdiscontinuity"><strong>IMediaSample::SetDiscontinuity</strong></a> method:</p>
<pre lang="C++"><code>void CMyStream::UpdateFromSeek()
{
    if (ThreadExists()) 
    {
        DeliverBeginFlush();
        Stop();
        DeliverEndFlush();
        Run();
    }
}

HRESULT CMyStream::OnThreadStartPlay()
{
    m_bDiscontinuity = TRUE;
    return DeliverNewSegment(m_rtStart, m_rtStop, m_dRateSeeking);
}
</code></pre>
<h3>Supporting Additional Time Formats</h3>
<p>By default, this class supports seeking only in units of reference time (TIME_FORMAT_MEDIA_TIME). To support additional time formats, override the <a href="/windows/desktop/api/Strmif/nn-strmif-imediaseeking"><strong>IMediaSeeking</strong></a> methods that deal with time formats:</p>
<ul>
<li><a href="/windows/desktop/api/Strmif/nf-strmif-imediaseeking-gettimeformat"><strong>IMediaSeeking::GetTimeFormat</strong></a></li>
<li><a href="/windows/desktop/api/Strmif/nf-strmif-imediaseeking-gettimeformat"><strong>IMediaSeeking::GetTimeFormat</strong></a></li>
<li><a href="/windows/desktop/api/Strmif/nf-strmif-imediaseeking-isusingtimeformat"><strong>IMediaSeeking::IsUsingTimeFormat</strong></a></li>
<li><a href="/windows/desktop/api/Strmif/nf-strmif-imediaseeking-isusingtimeformat"><strong>IMediaSeeking::IsUsingTimeFormat</strong></a></li>
<li><a href="/windows/desktop/api/Strmif/nf-strmif-imediaseeking-settimeformat"><strong>IMediaSeeking::SetTimeFormat</strong></a></li>
</ul>
<p>In addition, override the remaining <a href="/windows/desktop/api/Strmif/nn-strmif-imediaseeking"><strong>IMediaSeeking</strong></a> methods to perform the necessary conversions between time formats. After the <a href="/windows/desktop/api/Strmif/nf-strmif-imediaseeking-settimeformat"><strong>SetTimeFormat</strong></a> method is called, all <strong>IMediaSeeking</strong> methods must treat incoming and outgoing time parameters as being in the new time format. For example, if the <em>m_rtDuration</em> variable represents the duration in units of reference time, but the current time format is frames, then the <a href="/windows/desktop/api/Strmif/nf-strmif-imediaseeking-getduration"><strong>GetDuration</strong></a> method must return the value <em>m_rtDuration</em> converted to frames. For example:</p>
<pre><code>STDMETHODIMP GetDuration(LONGLONG *pDuration)
{
    HRESULT hr = CSourceSeeking::GetDuration(pDuration);
    if (SUCCEEDED(hr))
    {
        if (m_TimeFormat == TIME_FORMAT_FRAME)
        {
            // Convert from reference time to frames.
            *pDuration = TimeToFrame(*pDuration);  // Private method.
        }
    }
    return hr
} 
</code></pre>
<p>Also, make sure to check for the AM_SEEKING_ReturnTime flag in the <a href="/windows/desktop/api/Strmif/nf-strmif-imediaseeking-setpositions"><strong>IMediaSeeking::SetPositions</strong></a> method. If this flag is present, convert the position values into reference times when you return them to the caller.</p>
<h2>Requirements</h2>
<table>
<thead>
<tr>
<th>Requirement</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Header<!-- raw HTML omitted --></td>
<td><!-- raw HTML omitted --> <!-- raw HTML omitted -->Ctlutil.h (include Streams.h)<!-- raw HTML omitted --> <!-- raw HTML omitted --></td>
</tr>
<tr>
<td>Library<!-- raw HTML omitted --></td>
<td><!-- raw HTML omitted --> <!-- raw HTML omitted -->Strmbase.lib (retail builds); <!-- raw HTML omitted --> <!-- raw HTML omitted -->Strmbasd.lib (debug builds)<!-- raw HTML omitted --> <!-- raw HTML omitted --></td>
</tr>
</tbody>
</table>
<h2>See also</h2>
<!-- raw HTML omitted -->
<p><a href="supporting-seeking-in-a-source-filter.html">Supporting Seeking in a Source Filter</a></p>
<!-- raw HTML omitted -->
</body>
