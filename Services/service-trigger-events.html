<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Service Trigger Events</title>
<style>
table th { border: 1px solid; }
table td { border: 1px solid; }
</style>
</head>
<body>
<hr />
<h2>description: A service can register to be started or stopped when a trigger event occurs.
ms.assetid: ca02a3ae-b16a-4427-b6db-b935c9cf23b3
title: Service Trigger Events
ms.topic: article
ms.date: 05/31/2018</h2>
<h1>Service Trigger Events</h1>
<p>A service can register to be started or stopped when a trigger event occurs. This eliminates the need for services to start when the system starts, or for services to poll or actively wait for an event; a service can start when it is needed, instead of starting automatically whether or not there is work to do. Examples of predefined trigger events include arrival of a device of a specified device interface class or availability of a particular firewall port. A service can also register for a custom trigger event generated by an <a href="../etw/event-tracing-portal.html">Event Tracing for Windows</a> (ETW) provider.</p>
<p><strong>Windows ServerÂ 2008, WindowsÂ Vista, Windows ServerÂ 2003 and WindowsÂ XP:</strong> Service trigger events are not supported until Windows ServerÂ 2008Â R2 and WindowsÂ 7.</p>
<p>A trigger consists of a trigger event type, a trigger event subtype, the action to be taken in response to the trigger event, and (for certain trigger event types) one or more trigger-specific data items. The subtype and the trigger-specific data items together specify the conditions for notifying the service of the event. The format of a data item depends on the trigger event type; a data item can be binary data, a string, or a multistring. Strings must be Unicode; ANSI strings are not supported.</p>
<p>To register for trigger events, the service calls <a href="/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a"><strong>ChangeServiceConfig2</strong></a> with <strong>SERVICE_CONFIG_TRIGGER_INFO</strong> and supplies a <a href="/windows/desktop/api/winsvc/ns-winsvc-service_trigger_info"><strong>SERVICE_TRIGGER_INFO</strong></a> structure. The <strong>SERVICE_TRIGGER_INFO</strong> structure points to an array of <a href="/windows/desktop/api/winsvc/ns-winsvc-service_trigger"><strong>SERVICE_TRIGGER</strong></a> structures, each specifying one trigger.</p>
<p>The specified trigger action is taken if the trigger condition is true when the system starts, or if the trigger condition becomes true while the system is running. For example, if a service registers to be started when a particular device is available, the service is started when the system starts if the device is already plugged in to the computer; the service is started when the device arrives if the user plugs in the device while the system is running.</p>
<p>If a trigger has trigger-specific data items, the trigger action is taken only if the data item that accompanies the trigger event matches one of the data items that the service specified with the trigger. Binary data matching is done by bitwise comparison. String matching is case-insensitive. If the data item is a multistring, all strings in the multistring must match.</p>
<p>When a service is started in response to a trigger event, the service receives <strong>SERVICE_TRIGGER_STARTED_ARGUMENT</strong> as <em>argv</em>[1] in its <a href="/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona"><em>ServiceMain</em></a> callback function. <em>Argv</em>[0] is always the short name of the service.</p>
<p>A service that registers to be started in response to a trigger event might stop itself after an idle time-out when the service has no work to do. A service that stops itself must be prepared to handle <strong>SERVICE_CONTROL_TRIGGEREVENT</strong> control requests that arrive while the service is stopping itself. The SCM sends a <strong>SERVICE_CONTROL_TRIGGEREVENT</strong> control request whenever a new trigger event occurs while the service is in the running state. To avoid losing trigger events, the service should return <strong>ERROR_SHUTDOWN_IN_PROGRESS</strong> for any <strong>SERVICE_CONTROL_TRIGGEREVENT</strong> control request that arrives while the service is transitioning from running to stopped. This instructs the SCM to queue trigger events and wait for the service to enter the stopped state. The SCM then takes the action associated with the queued trigger event, such as starting the service.</p>
<p>When the service is ready to handle trigger events again, it sets <strong>SERVICE_ACCEPT_TRIGGEREVENT</strong> in its controls-accepted mask in a call to <a href="/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus"><strong>SetServiceStatus</strong></a>. This is usually done when the service calls <strong>SetServiceStatus</strong> with <strong>SERVICE_RUNNING</strong>. The SCM then issues a <strong>SERVICE_CONTROL_TRIGGEREVENT</strong> request for each queued trigger event until the queue is empty.</p>
<p>A service that has dependent services running cannot be stopped in response to a trigger event.</p>
<p>Trigger-start and trigger-stop requests are not guaranteed under low memory conditions.</p>
<p>Use the <a href="/windows/desktop/api/Winsvc/nf-winsvc-queryserviceconfig2a"><strong>QueryServiceConfig2</strong></a> function to retrieve a serviceâ€™s trigger event configuration.</p>
<p>The SC tool (sc.exe) can be used to configure or query a serviceâ€™s trigger events at the command prompt. Use the <strong>triggerinfo</strong> option to configure a service to start or stop in response to a trigger event. Use the <strong>qtriggerinfo</strong> option to query the trigger configuration of a service.</p>
<p>The following example queries the trigger configuration of the W32time service, which is configured to start when the computer is joined to a domain and stop when the computer leaves the domain.</p>
<pre lang="syntax"><code>C:\&gt;sc qtriggerinfo w32time
[SC] QueryServiceConfig2 SUCCESS

SERVICE_NAME: w32time

        START SERVICE
          DOMAIN JOINED STATUS         : 1ce20aba-9851-4421-9430-1ddeb766e809 [DOMAIN JOINED]
        STOP SERVICE
          DOMAIN JOINED STATUS         : ddaf516e-58c2-4866-9574-c3b615d42ea1 [NOT DOMAIN JOINED]
</code></pre>
<p>The following example queries the trigger configuration of the tablet input service, which is configured to start when a HID device with the <strong>GUID</strong> {4d1e55b2-f16f-11cf-88cb-001111000030} and any of the specified HID device IDs arrives.</p>
<pre lang="syntax"><code>C:\&gt;sc qtriggerinfo tabletinputservice
[SC] QueryServiceConfig2 SUCCESS

SERVICE_NAME: tabletinputservice

        START SERVICE
          DEVICE INTERFACE ARRIVAL     : 4d1e55b2-f16f-11cf-88cb-001111000030 [INTERFACE CLASS GUID]
            DATA                       : HID_DEVICE_UP:000D_U:0001
            DATA                       : HID_DEVICE_UP:000D_U:0002
            DATA                       : HID_DEVICE_UP:000D_U:0003
            DATA                       : HID_DEVICE_UP:000D_U:0004
</code></pre>
<p>Â </p>
<p>Â </p>
</body>
