<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Writing a Service Program's main Function</title>
<style>
table th { border: 1px solid; }
table td { border: 1px solid; }
</style>
</head>
<body>
<hr />
<h2>description: The following example can be used as the entry point for a service program that supports a single service.
ms.assetid: 7fdfc20a-9148-4ae1-8101-7a387c0d0edc
title: Writing a Service Programs main Function
ms.topic: article
ms.date: 05/31/2018</h2>
<h1>Writing a Service Program's main Function</h1>
<p>The <strong>main</strong> function of a <a href="service-programs.html">service program</a> calls the <a href="/windows/desktop/api/Winsvc/nf-winsvc-startservicectrldispatchera"><strong>StartServiceCtrlDispatcher</strong></a> function to connect to the <a href="service-control-manager.html">service control manager</a> (SCM) and start the control dispatcher thread. The dispatcher thread loops, waiting for incoming control requests for the services specified in the dispatch table. This thread returns when there is an error or when all of the services in the process have terminated. When all services in the process have terminated, the SCM sends a control request to the dispatcher thread telling it to exit. This thread then returns from the <strong>StartServiceCtrlDispatcher</strong> call and the process can terminate.</p>
<p>The following global definitions are used in this sample.</p>
<pre lang="C++"><code>#define SVCNAME TEXT(&quot;SvcName&quot;)

SERVICE_STATUS          gSvcStatus; 
SERVICE_STATUS_HANDLE   gSvcStatusHandle; 
HANDLE                  ghSvcStopEvent = NULL;
</code></pre>
<p>The following example can be used as the entry point for a service program that supports a single service. If your service program supports multiple services, add the names of the additional services to the dispatch table so they can be monitored by the dispatcher thread.</p>
<p>The _tmain function is the entry point. The SvcReportEvent function writes informational messages and errors to the event log. For information about writing the SvcMain function, see <a href="writing-a-servicemain-function.html">Writing a ServiceMain Function</a>. For more information about the SvcInstall function, see <a href="installing-a-service.html">Installing a Service</a>. For information about writing the SvcCtrlHandler function, see <a href="writing-a-control-handler-function.html">Writing a Control Handler Function</a>. For the complete example service, including the source for the SvcReportEvent function, see <a href="svc-cpp.html">Svc.cpp</a>.</p>
<pre lang="C++"><code>//
// Purpose: 
//   Entry point for the process
//
// Parameters:
//   None
// 
// Return value:
//   None, defaults to 0 (zero)
//
int __cdecl _tmain(int argc, TCHAR *argv[])
{ 
    // If command-line parameter is &quot;install&quot;, install the service. 
    // Otherwise, the service is probably being started by the SCM.

    if( lstrcmpi( argv[1], TEXT(&quot;install&quot;)) == 0 )
    {
        SvcInstall();
        return;
    }

    // TO_DO: Add any additional services for the process to this table.
    SERVICE_TABLE_ENTRY DispatchTable[] = 
    { 
        { SVCNAME, (LPSERVICE_MAIN_FUNCTION) SvcMain }, 
        { NULL, NULL } 
    }; 
 
    // This call returns when the service has stopped. 
    // The process should simply terminate when the call returns.

    if (!StartServiceCtrlDispatcher( DispatchTable )) 
    { 
        SvcReportEvent(TEXT(&quot;StartServiceCtrlDispatcher&quot;)); 
    } 
} 

</code></pre>
<p>The following is an example Sample.h as generated by the message compiler. For more information, see <a href="sample-mc.html">Sample.mc</a>.</p>
<pre lang="syntax"><code> // The following are message definitions.
//
//  Values are 32 bit values layed out as follows:
//
//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
//  +---+-+-+-----------------------+-------------------------------+
//  |Sev|C|R|     Facility          |               Code            |
//  +---+-+-+-----------------------+-------------------------------+
//
//  where
//
//      Sev - is the severity code
//
//          00 - Success
//          01 - Informational
//          10 - Warning
//          11 - Error
//
//      C - is the Customer code flag
//
//      R - is a reserved bit
//
//      Facility - is the facility code
//
//      Code - is the facility's status code
//
//
// Define the facility codes
//
#define FACILITY_SYSTEM                  0x0
#define FACILITY_STUBS                   0x3
#define FACILITY_RUNTIME                 0x2
#define FACILITY_IO_ERROR_CODE           0x4


//
// Define the severity codes
//
#define STATUS_SEVERITY_WARNING          0x2
#define STATUS_SEVERITY_SUCCESS          0x0
#define STATUS_SEVERITY_INFORMATIONAL    0x1
#define STATUS_SEVERITY_ERROR            0x3


//
// MessageId: SVC_ERROR
//
// MessageText:
//
//  An error has occurred (%2).
//  
//
#define SVC_ERROR                        ((DWORD)0xC0020001L)
</code></pre>
<h2>Related topics</h2>
<!-- raw HTML omitted -->
<p><a href="service-entry-point.html">Service Entry Point</a></p>
<!-- raw HTML omitted -->
<p><a href="the-complete-service-sample.html">The Complete Service Sample</a></p>
<!-- raw HTML omitted -->
<p>Â </p>
<p>Â </p>
</body>
